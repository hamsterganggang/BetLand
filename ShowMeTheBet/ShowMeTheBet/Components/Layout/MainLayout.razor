@inherits LayoutComponentBase
@using ShowMeTheBet.Services
@using Microsoft.JSInterop
@inject AuthService AuthService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<div class="page">
    <div class="top-navbar">
        <div class="navbar-container">
            <div class="navbar-left">
                <a class="navbar-brand" href="/game">âš½ ë„í† ë¦¬</a>
                <div class="navbar-menu">
                    <NavLink class="nav-menu-item" href="/ranking" Match="NavLinkMatch.Prefix">
                        <span class="bi bi-trophy-fill"></span> ë¶€ìë­í‚¹
                    </NavLink>
                    @if (IsAuthenticated())
                    {
                        <NavLink class="nav-menu-item" href="/sports" Match="NavLinkMatch.Prefix">
                            <span class="bi bi-trophy"></span> ìŠ¤í¬ì¸ 
                        </NavLink>
                        <NavLink class="nav-menu-item" href="/oddeven" Match="NavLinkMatch.Prefix">
                            <span class="bi bi-dice-6"></span> í™€ì§
                        </NavLink>
                        <NavLink class="nav-menu-item" href="/graph" Match="NavLinkMatch.Prefix">
                            <span class="bi bi-graph-up"></span> ê·¸ë˜í”„
                        </NavLink>
                    }
                </div>
            </div>
            <div class="navbar-right">
                @if (IsAuthenticated())
                {
                    <div class="user-info">
                        <span class="username">@AuthService.CurrentUser?.Username</span>
                        <span class="balance">ì”ì•¡: @(GetBalance().ToString("N0")) ì›</span>
                    </div>
                    <button class="btn-logout" type="button" onclick="window.logout(); return false;">
                        <span class="bi bi-box-arrow-right"></span> ë¡œê·¸ì•„ì›ƒ
                    </button>
                }
                else
                {
                    <NavLink class="btn-login" href="/login">
                        <span class="bi bi-box-arrow-in-right"></span> ë¡œê·¸ì¸
                    </NavLink>
                }
            </div>
        </div>
    </div>

    <main>
        <article class="content">
            @Body
        </article>
    </main>
</div>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">ğŸ—™</span>
</div>

@code {
    private bool IsAuthenticated()
    {
        // CurrentUserë¥¼ ì§ì ‘ í™•ì¸ (ì¿ í‚¤ì—ì„œ ë¡œë“œ)
        return AuthService.CurrentUser != null;
    }

    private decimal GetBalance()
    {
        return AuthService.CurrentUser?.Balance ?? 0;
    }

    private async Task HandleLogoutAsync()
    {
        // ë””ë²„ê¹…: ì½˜ì†”ì— ë¡œê·¸ ì¶œë ¥
        try
        {
            await JSRuntime.InvokeVoidAsync("console.log", "ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í´ë¦­ë¨ - HandleLogoutAsync í˜¸ì¶œ");
        }
        catch { }

        try
        {
            // navigation.jsì˜ logout í•¨ìˆ˜ í˜¸ì¶œ
            await JSRuntime.InvokeVoidAsync("console.log", "logout í•¨ìˆ˜ í˜¸ì¶œ ì‹œë„");
            await JSRuntime.InvokeVoidAsync("logout");
        }
        catch (Exception ex)
        {
            // ë””ë²„ê¹…: ì˜¤ë¥˜ ë¡œê·¸ ì¶œë ¥
            try
            {
                await JSRuntime.InvokeVoidAsync("console.error", $"ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜: {ex.Message}");
            }
            catch { }

            // JavaScript í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ëŒ€ì²´ ë°©ë²•ë“¤ ì‹œë„
            try
            {
                // ë°©ë²• 1: ì§ì ‘ JavaScript ì‹¤í–‰
                await JSRuntime.InvokeVoidAsync("eval", "console.log('ë°©ë²• 1 ì‹œë„'); window.location.href = '/login';");
            }
            catch
            {
                try
                {
                    // ë°©ë²• 2: window.location.replace ì‚¬ìš©
                    await JSRuntime.InvokeVoidAsync("eval", "console.log('ë°©ë²• 2 ì‹œë„'); window.location.replace('/login');");
                }
                catch
                {
                    try
                    {
                        // ë°©ë²• 3: ì§ì ‘ í˜ì´ì§€ ì´ë™
                        await JSRuntime.InvokeVoidAsync("eval", "console.log('ë°©ë²• 3 ì‹œë„'); window.location = '/login';");
                    }
                    catch
                    {
                        // ë°©ë²• 4: Navigation ì‚¬ìš© (ìµœí›„ì˜ ìˆ˜ë‹¨)
                        AuthService.Logout();
                        StateHasChanged();
                        await Task.Delay(100);
                        Navigation.NavigateTo("/login", forceLoad: true);
                    }
                }
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        // ì„¸ì…˜ì—ì„œ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
        AuthService.ResetUserLoad();
        await AuthService.LoadUserFromSessionAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            AuthService.OnAuthStateChanged += () => InvokeAsync(StateHasChanged);
        }
        
        // ë§¤ë²ˆ ë Œë”ë§ í›„ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ë™ì ìœ¼ë¡œ ìƒì„±ë˜ëŠ” ê²½ìš° ëŒ€ë¹„)
        try
        {
            await JSRuntime.InvokeVoidAsync("eval", @"
                (function() {
                    console.log('OnAfterRenderAsync ì‹¤í–‰ - ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì°¾ëŠ” ì¤‘...');
                    const logoutBtn = document.querySelector('.btn-logout');
                    console.log('ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì°¾ê¸° ê²°ê³¼:', logoutBtn);
                    
                    if (logoutBtn) {
                        // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° í›„ ìƒˆë¡œ ì¶”ê°€
                        const newBtn = logoutBtn.cloneNode(true);
                        logoutBtn.parentNode.replaceChild(newBtn, logoutBtn);
                        
                        // ìƒˆ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                        newBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('JavaScript ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆì—ì„œ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í´ë¦­ë¨!');
                            if (window.logout) {
                                console.log('window.logout í•¨ìˆ˜ í˜¸ì¶œ');
                                window.logout();
                            } else {
                                console.error('window.logout í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                                window.location.href = '/login';
                            }
                        });
                        
                        // onclick ì†ì„±ë„ ì¶”ê°€
                        newBtn.setAttribute('onclick', 'window.logout(); return false;');
                        
                        console.log('ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ì— JavaScript ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ ì™„ë£Œ');
                    } else {
                        console.warn('ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    }
                })();
            ");
        }
        catch (Exception ex)
        {
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ ì‹¤íŒ¨ëŠ” ë¬´ì‹œ
            try
            {
                await JSRuntime.InvokeVoidAsync("console.error", $"ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ ì˜¤ë¥˜: {ex.Message}");
            }
            catch { }
        }
    }
}

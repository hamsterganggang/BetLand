@page "/login"
@inject ShowMeTheBet.Services.AuthPageService AuthPageService
@rendermode InteractiveServer

<PageTitle>로그인 - 도토리</PageTitle>

<div class="auth-page">
    <div class="auth-card">
        <div class="auth-visual">
            <div>
                <h1>도토리에 오신 것을 환영합니다</h1>
                <p>맞춤형 게임과 실시간 배당으로 새로운 도토리 모으기를 시작하세요.</p>
                <ul>
                    <li>실시간 그래프 × 홀짝 게임</li>
                    <li>스포츠 경기 라이브 도토리</li>
                    <li>효율적인 자산 관리</li>
                    <li>* 본 페이지는 건강한 베팅 놀이터 입니다.</li>
                </ul>
            </div>
        </div>

        <div class="auth-form">
            <div class="auth-header">
                <h2>로그인</h2>
                <p class="text-muted">계정 정보를 입력해 주십시오.</p>
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger" role="alert">
                    @errorMessage
                </div>
            }

            <form method="post" action="/api/auth/login" id="loginForm">
                <div class="form-group">
                    <label for="username" class="form-label">사용자명</label>
                    <input type="text"
                           class="form-control"
                           id="username"
                           name="username"
                           @bind="username"
                           placeholder="사용자명을 입력하세요"
                           required />
                </div>

                <div class="form-group">
                    <label for="password" class="form-label">비밀번호</label>
                    <input type="password"
                           class="form-control"
                           id="password"
                           name="password"
                           @bind="password"
                           @onkeypress="HandleKeyPress"
                           placeholder="비밀번호를 입력하세요"
                           required />
                </div>

                <button type="button" class="btn btn-primary w-100 mb-3" @onclick="HandleLogin" disabled="@isLoading">
                    @if (isLoading)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                    }
                    로그인
                </button>

                <div class="text-center">
                    <p class="mb-0">계정이 없으신가요? <a href="/register">회원가입</a></p>
                </div>
            </form>
        </div>
    </div>
</div>

@code {
    private string username = string.Empty;
    private string password = string.Empty;
    private string errorMessage = string.Empty;
    private bool isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        await AuthPageService.RedirectIfAuthenticatedAsync();
    }

    private async Task HandleLogin()
    {
        errorMessage = string.Empty;
        
        isLoading = true;
        StateHasChanged();
        
        var result = await AuthPageService.LoginAsync(username, password);
        isLoading = false;

        if (!result.Success)
        {
            errorMessage = result.ErrorMessage ?? "로그인 중 오류가 발생했습니다.";
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await HandleLogin();
        }
    }
}


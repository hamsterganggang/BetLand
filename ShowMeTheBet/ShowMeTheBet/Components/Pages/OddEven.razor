@page "/oddeven"
@using ShowMeTheBet.Models
@using ShowMeTheBet.Services
@using Microsoft.JSInterop
@inject GameService GameService
@inject AuthService AuthService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer
@implements IAsyncDisposable

<PageTitle>í™€ì§ ê²Œì„ - ShowMeTheBet</PageTitle>

@if (isLoading)
{
    <div style="text-align: center; padding: 50px;">
        <p>ë¡œë”© ì¤‘...</p>
    </div>
}
else if (!isAuthenticated)
{
    <div class="auth-required">
        <div class="auth-message">
            <h2>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h2>
            <p>ê²Œì„ì„ í•˜ë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>
            <button class="btn btn-primary" @onclick="NavigateToLogin">ë¡œê·¸ì¸í•˜ê¸°</button>
        </div>
    </div>
}
else
{
    <div class="game-container">
        <div class="game-header">
            <h1>ğŸ² í™€ì§ ê²Œì„</h1>
            <div class="balance-display">
                <span class="balance-label">ì”ì•¡:</span>
                <span class="balance-amount">@balance.ToString("N0") ì›</span>
            </div>
        </div>

        <div class="game-content">
            <div class="game-main">
                <div class="round-info">
                    <h2>ë‹¤ìŒ ë¼ìš´ë“œê¹Œì§€</h2>
                    <div class="countdown">@timeLeft ì´ˆ</div>
                    <div class="current-result">
                        <span class="result-label">í˜„ì¬ ê²°ê³¼:</span>
                        <span class="result-value @(currentResult == "í™€" ? "odd" : "even")">@currentResult</span>
                    </div>
                </div>

                <div class="bet-section">
                    <h3>ë² íŒ…í•˜ê¸°</h3>
                    <div class="bet-amount-input">
                        <label>ë² íŒ… ê¸ˆì•¡:</label>
                        <input type="number" 
                               class="form-control" 
                               value="@betAmount" 
                               @oninput="OnBetAmountInput"
                               min="1000" 
                               step="1000"
                               placeholder="ê¸ˆì•¡ ì…ë ¥" />
                        <div class="quick-amount-buttons">
                            <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="() => SetBetAmount(0.25m)" disabled="@(balance <= 0 || timeLeft < 5 || isLoading)">
                                25%
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="() => SetBetAmount(0.50m)" disabled="@(balance <= 0 || timeLeft < 5 || isLoading)">
                                50%
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="() => SetBetAmount(0.75m)" disabled="@(balance <= 0 || timeLeft < 5 || isLoading)">
                                75%
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="() => SetBetAmount(1.00m)" disabled="@(balance <= 0 || timeLeft < 5 || isLoading)">
                                100%
                            </button>
                        </div>
                    </div>
                    <div class="bet-buttons">
                        <button class="btn btn-odd @(selectedChoice == "í™€" ? "selected" : "")" 
                                @onclick="SelectOdd"
                                disabled="@(timeLeft < 5 || isLoading)">
                            í™€ (x2.0)
                        </button>
                        <button class="btn btn-even @(selectedChoice == "ì§" ? "selected" : "")" 
                                @onclick="SelectEven"
                                disabled="@(timeLeft < 5 || isLoading)">
                            ì§ (x2.0)
                        </button>
                    </div>
                    @if (selectedChoice != "" && betAmount > 0)
                    {
                        <div class="bet-summary">
                            <p>ì„ íƒ: <strong>@selectedChoice</strong></p>
                            <p>ë² íŒ… ê¸ˆì•¡: <strong>@betAmount.ToString("N0") ì›</strong></p>
                            <p>ì˜ˆìƒ ë‹¹ì²¨ê¸ˆ: <strong>@((betAmount * 2).ToString("N0")) ì›</strong></p>
                        </div>
                    }
                    <button class="btn btn-primary btn-bet" 
                            @onclick="PlaceBet"
                            disabled="@IsBetDisabled()">
                        @if (isLoading)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        ë² íŒ…í•˜ê¸°
                    </button>
                </div>
            </div>

            <div class="game-history">
                <h3>ë² íŒ… ë‚´ì—­</h3>
                @if (bets == null || bets.Count == 0)
                {
                    <div class="empty-history">
                        <p>ë² íŒ… ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                }
                else
                {
                    <div class="bets-list">
                        @foreach (var bet in bets)
                        {
                            <div class="bet-item @bet.Status.ToString().ToLower()">
                                <div class="bet-info">
                                    <span class="bet-choice">@bet.BetChoice</span>
                                    <span class="bet-amount">@bet.Amount.ToString("N0") ì›</span>
                                </div>
                                <div class="bet-result">
                                    <span class="result">ê²°ê³¼: @bet.Result</span>
                                    @if (bet.Status == GameBetStatus.Won)
                                    {
                                        <span class="win-amount">+@bet.WinAmount.ToString("N0") ì›</span>
                                    }
                                    else if (bet.Status == GameBetStatus.Lost)
                                    {
                                        <span class="lose-amount">-@bet.Amount.ToString("N0") ì›</span>
                                    }
                                    else
                                    {
                                        <span class="pending">ëŒ€ê¸°ì¤‘...</span>
                                    }
                                </div>
                                <div class="bet-time">@bet.BetTime.ToString("HH:mm:ss")</div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
}

@code {
    private decimal balance = 0;
    private int timeLeft = 30;
    private string currentResult = "í™€";
    private string selectedChoice = "";
    private decimal betAmount = 0;
    private bool isLoading = true;
    private bool isAuthenticated = false;
    private List<GameBet>? bets;
    private System.Threading.Timer? timer;
    private DateTime lastRoundTime = DateTime.MinValue;

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        StateHasChanged();
        
        try
        {
            // ì‹¤ì„œë²„(IIS)ì—ì„œ SignalR ì—°ê²°ì˜ HttpContext ì ‘ê·¼ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´
            // JavaScript Interopì„ í†µí•´ APIë¥¼ í˜¸ì¶œí•˜ì—¬ ì¸ì¦ ìƒíƒœ í™•ì¸
            try
            {
                var authResult = await JSRuntime.InvokeAsync<AuthCheckResult>("checkAuth");
                if (authResult != null && authResult.authenticated && authResult.userId.HasValue)
                {
                    // API ì‘ë‹µì„ ê¸°ë°˜ìœ¼ë¡œ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
                    await AuthService.LoadUserByIdAsync(authResult.userId.Value);
                    isAuthenticated = true;
                    // API ì‘ë‹µì˜ balanceë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜, RefreshUserAsync í›„ LoadData í˜¸ì¶œ
                    if (authResult.balance.HasValue)
                    {
                        balance = authResult.balance.Value;
                    }
                    else
                    {
                        await AuthService.RefreshUserAsync();
                        balance = await GameService.GetBalanceAsync();
                    }
                    // ë‚˜ë¨¸ì§€ ë°ì´í„° ë¡œë“œ
                    timeLeft = await GameService.GetTimeUntilNextRoundAsync();
                    currentResult = await GameService.GetCurrentOddEvenResultAsync();
                    bets = await GameService.GetOddEvenBetsAsync(authResult.userId.Value);
                    lastRoundTime = DateTime.Now;
                    InitializeTimer();
                    StartTimer();
                }
                else
                {
                    // API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ì§ì ‘ í™•ì¸ (ë¡œì»¬ í™˜ê²½ ëŒ€ë¹„)
                    AuthService.ResetUserLoad();
                    await AuthService.LoadUserFromSessionAsync();
                    var user = AuthService.CurrentUser;
                    isAuthenticated = user != null;
                    
                    if (isAuthenticated)
                    {
                        await AuthService.RefreshUserAsync();
                        balance = await GameService.GetBalanceAsync();
                        timeLeft = await GameService.GetTimeUntilNextRoundAsync();
                        currentResult = await GameService.GetCurrentOddEvenResultAsync();
                        // userId ê°€ì ¸ì˜¤ê¸°
                        int? userId = null;
                        if (AuthService.CurrentUser != null)
                        {
                            userId = AuthService.CurrentUser.Id;
                        }
                        else
                        {
                            try
                            {
                                var authResult2 = await JSRuntime.InvokeAsync<AuthCheckResult>("checkAuth");
                                if (authResult2 != null && authResult2.authenticated && authResult2.userId.HasValue)
                                {
                                    userId = authResult2.userId.Value;
                                }
                            }
                            catch { }
                        }
                        bets = await GameService.GetOddEvenBetsAsync(userId);
                        lastRoundTime = DateTime.Now;
                        InitializeTimer();
                        StartTimer();
                    }
                }
            }
            catch
            {
                // API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ì§ì ‘ í™•ì¸
                AuthService.ResetUserLoad();
                await AuthService.LoadUserFromSessionAsync();
                var user = AuthService.CurrentUser;
                isAuthenticated = user != null;
                
                if (isAuthenticated)
                {
                    await AuthService.RefreshUserAsync();
                    balance = await GameService.GetBalanceAsync();
                    timeLeft = await GameService.GetTimeUntilNextRoundAsync();
                    currentResult = await GameService.GetCurrentOddEvenResultAsync();
                    // userId ê°€ì ¸ì˜¤ê¸°
                    int? userId2 = null;
                    if (AuthService.CurrentUser != null)
                    {
                        userId2 = AuthService.CurrentUser.Id;
                    }
                    else
                    {
                        try
                        {
                            var authResult3 = await JSRuntime.InvokeAsync<AuthCheckResult>("checkAuth");
                            if (authResult3 != null && authResult3.authenticated && authResult3.userId.HasValue)
                            {
                                userId2 = authResult3.userId.Value;
                            }
                        }
                        catch { }
                    }
                    bets = await GameService.GetOddEvenBetsAsync(userId2);
                    lastRoundTime = DateTime.Now;
                    InitializeTimer();
                    StartTimer();
                }
            }
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !isAuthenticated)
        {
            // ì²« ë Œë”ë§ í›„ì—ë„ ì¸ì¦ ìƒíƒœë¥¼ ë‹¤ì‹œ í™•ì¸ (SignalR ì—°ê²° í›„ HttpContextê°€ ì„¤ì •ë  ìˆ˜ ìˆìŒ)
            await CheckAuthAndLoadData();
        }
    }

    private async Task CheckAuthAndLoadData()
    {
        try
        {
            var authResult = await JSRuntime.InvokeAsync<AuthCheckResult>("checkAuth");
            if (authResult != null && authResult.authenticated && authResult.userId.HasValue)
            {
                var wasAuthenticated = isAuthenticated;
                await AuthService.LoadUserByIdAsync(authResult.userId.Value);
                isAuthenticated = true;
                
                if (!wasAuthenticated)
                {
                    // API ì‘ë‹µì˜ balanceë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜, RefreshUserAsync í›„ GetBalanceAsync í˜¸ì¶œ
                    if (authResult.balance.HasValue)
                    {
                        balance = authResult.balance.Value;
                    }
                    else
                    {
                        await AuthService.RefreshUserAsync();
                        balance = await GameService.GetBalanceAsync();
                    }
                    timeLeft = await GameService.GetTimeUntilNextRoundAsync();
                    currentResult = await GameService.GetCurrentOddEvenResultAsync();
                    bets = await GameService.GetOddEvenBetsAsync(authResult.userId.Value);
                    lastRoundTime = DateTime.Now;
                    InitializeTimer();
                    StartTimer();
                    StateHasChanged();
                }
            }
        }
        catch { }
    }

    private class AuthCheckResult
    {
        public bool success { get; set; }
        public bool authenticated { get; set; }
        public int? userId { get; set; }
        public string? username { get; set; }
        public decimal? balance { get; set; }
    }

    private async Task LoadData()
    {
        // ì‚¬ìš©ì ì •ë³´ë¥¼ ìµœì‹ í™”í•œ í›„ ì”ì•¡ ë¡œë“œ
        await AuthService.RefreshUserAsync();
        if (AuthService.CurrentUser != null)
        {
            balance = AuthService.CurrentUser.Balance;
        }
        else
        {
            balance = await GameService.GetBalanceAsync();
        }
        timeLeft = await GameService.GetTimeUntilNextRoundAsync();
        currentResult = await GameService.GetCurrentOddEvenResultAsync();
                        // userId ê°€ì ¸ì˜¤ê¸°
                        int? userId = null;
                        if (AuthService.CurrentUser != null)
                        {
                            userId = AuthService.CurrentUser.Id;
                        }
                        else
                        {
                            try
                            {
                                var authResult = await JSRuntime.InvokeAsync<AuthCheckResult>("checkAuth");
                                if (authResult != null && authResult.authenticated && authResult.userId.HasValue)
                                {
                                    userId = authResult.userId.Value;
                                }
                            }
                            catch { }
                        }
                        bets = await GameService.GetOddEvenBetsAsync(userId);
        lastRoundTime = DateTime.Now;
        StateHasChanged();
    }

    private void InitializeTimer()
    {
        // ì´ˆê¸° ì‹œê°„ ê³„ì‚°
        var now = DateTime.Now;
        var secondsSinceEpoch = (long)(now - new DateTime(1970, 1, 1)).TotalSeconds;
        var currentRound = secondsSinceEpoch / 30;
        var nextRoundTime = (currentRound + 1) * 30;
        var nextRoundDateTime = new DateTime(1970, 1, 1).AddSeconds(nextRoundTime);
        timeLeft = (int)(nextRoundDateTime - now).TotalSeconds;
        if (timeLeft <= 0) timeLeft = 30;
    }

    private void StartTimer()
    {
        timer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                // í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ ì§ì ‘ ê³„ì‚°
                var now = DateTime.Now;
                var secondsSinceEpoch = (long)(now - new DateTime(1970, 1, 1)).TotalSeconds;
                var currentRound = secondsSinceEpoch / 30;
                var nextRoundTime = (currentRound + 1) * 30;
                var nextRoundDateTime = new DateTime(1970, 1, 1).AddSeconds(nextRoundTime);
                var newTimeLeft = (int)(nextRoundDateTime - now).TotalSeconds;
                
                if (newTimeLeft <= 0)
                {
                    newTimeLeft = 30;
                }

                var previousTimeLeft = timeLeft;
                timeLeft = newTimeLeft;

                // ë¼ìš´ë“œê°€ ë°”ë€Œì—ˆëŠ”ì§€ í™•ì¸ (30ì—ì„œ 29ë¡œ ë„˜ì–´ê°ˆ ë•Œ)
                if (previousTimeLeft == 30 && newTimeLeft < 30)
                {
                    // ìƒˆ ë¼ìš´ë“œ ì‹œì‘ - ì„œë²„ì—ì„œ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                    currentResult = await GameService.GetCurrentOddEvenResultAsync();
                    
                    // ì”ì•¡ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                    _ = Task.Run(async () =>
                    {
                        try
                        {
                            await AuthService.RefreshUserAsync();
                            if (AuthService.CurrentUser != null)
                            {
                                await InvokeAsync(() =>
                                {
                                    balance = AuthService.CurrentUser.Balance;
                                    StateHasChanged();
                                });
                            }
                            
                            // userId ê°€ì ¸ì˜¤ê¸°
                            int? userId3 = null;
                            if (AuthService.CurrentUser != null)
                            {
                                userId3 = AuthService.CurrentUser.Id;
                            }
                            else
                            {
                                try
                                {
                                    var authResult4 = await JSRuntime.InvokeAsync<AuthCheckResult>("checkAuth");
                                    if (authResult4 != null && authResult4.authenticated && authResult4.userId.HasValue)
                                    {
                                        userId3 = authResult4.userId.Value;
                                    }
                                }
                                catch { }
                            }
                            
                            var updatedBets = await GameService.GetOddEvenBetsAsync(userId3);
                            await InvokeAsync(() =>
                            {
                                bets = updatedBets;
                                StateHasChanged();
                            });
                        }
                        catch { }
                    });
                }

                StateHasChanged();
            });
        }, null, TimeSpan.Zero, TimeSpan.FromSeconds(1));
    }

    private void OnBetAmountInput(ChangeEventArgs e)
    {
        if (decimal.TryParse(e.Value?.ToString(), out var amount))
        {
            betAmount = amount;
            StateHasChanged();
        }
    }

    private void SetBetAmount(decimal percentage)
    {
        if (balance > 0)
        {
            betAmount = Math.Floor(balance * percentage / 1000) * 1000; // 1000ì› ë‹¨ìœ„ë¡œ ë‚´ë¦¼
            if (betAmount < 1000) betAmount = 1000; // ìµœì†Œ 1000ì›
            StateHasChanged();
        }
    }

    private void SelectOdd()
    {
        selectedChoice = "í™€";
        StateHasChanged();
    }

    private void SelectEven()
    {
        selectedChoice = "ì§";
        StateHasChanged();
    }

    private bool IsBetDisabled()
    {
        return string.IsNullOrEmpty(selectedChoice) || betAmount <= 0 || timeLeft < 5 || isLoading;
    }

    private async Task PlaceBet()
    {
        if (string.IsNullOrEmpty(selectedChoice) || betAmount <= 0) return;
        
        try
        {
            // ë² íŒ… ì „ì— ì‚¬ìš©ì ì •ë³´ ë‹¤ì‹œ ë¡œë“œ - ì—¬ëŸ¬ ë°©ë²•ìœ¼ë¡œ ì‹œë„
            if (AuthService.CurrentUser == null)
            {
                // 1. ì„¸ì…˜ì—ì„œ ë¡œë“œ ì‹œë„
                await AuthService.LoadUserFromSessionAsync();
                
                // 2. ì—¬ì „íˆ nullì´ë©´ APIë¥¼ í†µí•´ ë¡œë“œ
                if (AuthService.CurrentUser == null)
                {
                    try
                    {
                        var authResult = await JSRuntime.InvokeAsync<AuthCheckResult>("checkAuth");
                        if (authResult != null && authResult.authenticated && authResult.userId.HasValue)
                        {
                            await AuthService.LoadUserByIdAsync(authResult.userId.Value);
                        }
                    }
                    catch { }
                }
            }
            
            // ì”ì•¡ í™•ì¸ - CurrentUserê°€ nullì´ì–´ë„ APIì—ì„œ ì”ì•¡ì„ ë°›ì•˜ìœ¼ë©´ ì‚¬ìš©
            decimal currentBalance = 0;
            if (AuthService.CurrentUser != null)
            {
                currentBalance = AuthService.CurrentUser.Balance;
            }
            else
            {
                // APIë¥¼ í†µí•´ ì”ì•¡ ê°€ì ¸ì˜¤ê¸°
                try
                {
                    var authResult = await JSRuntime.InvokeAsync<AuthCheckResult>("checkAuth");
                    if (authResult != null && authResult.authenticated && authResult.balance.HasValue)
                    {
                        currentBalance = authResult.balance.Value;
                    }
                    else
                    {
                        isLoading = false;
                        StateHasChanged();
                        return;
                    }
                }
                catch
                {
                    isLoading = false;
                    StateHasChanged();
                    return;
                }
            }
            
            if (currentBalance < betAmount)
            {
                await AuthService.RefreshUserAsync();
                if (AuthService.CurrentUser != null)
                {
                    currentBalance = AuthService.CurrentUser.Balance;
                }
            }
            
            if (currentBalance < betAmount)
            {
                isLoading = false;
                balance = currentBalance;
                StateHasChanged();
                return;
            }
            
            // APIì—ì„œ userId ê°€ì ¸ì˜¤ê¸° (CurrentUserê°€ nullì¸ ê²½ìš°)
            int? userId = null;
            if (AuthService.CurrentUser != null)
            {
                userId = AuthService.CurrentUser.Id;
            }
            else
            {
                try
                {
                    var authResult = await JSRuntime.InvokeAsync<AuthCheckResult>("checkAuth");
                    if (authResult != null && authResult.authenticated && authResult.userId.HasValue)
                    {
                        userId = authResult.userId.Value;
                    }
                }
                catch { }
            }
            
            var success = await GameService.PlaceOddEvenBetAsync(selectedChoice, betAmount, userId);
            if (success)
            {
                // ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸
                balance -= betAmount;
                selectedChoice = "";
                betAmount = 0;
                StateHasChanged();
                
                // ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì •í™•í•œ ì”ì•¡ê³¼ ë°ì´í„° ì—…ë°ì´íŠ¸
                _ = Task.Run(async () =>
                {
                    try
                    {
                        // ì”ì•¡ ì—…ë°ì´íŠ¸ (ë² íŒ… í›„ ì°¨ê°ëœ ì”ì•¡)
                        await AuthService.RefreshUserAsync();
                        if (AuthService.CurrentUser != null)
                        {
                            await InvokeAsync(() =>
                            {
                                balance = AuthService.CurrentUser.Balance;
                                StateHasChanged();
                            });
                        }
                        
                        // ë‚˜ë¨¸ì§€ ë°ì´í„° ë¡œë“œ
                        var newTimeLeft = await GameService.GetTimeUntilNextRoundAsync();
                        var newCurrentResult = await GameService.GetCurrentOddEvenResultAsync();
                        
                        // userId ê°€ì ¸ì˜¤ê¸°
                        int? userIdForBets = userId;
                        if (userIdForBets == null)
                        {
                            if (AuthService.CurrentUser != null)
                            {
                                userIdForBets = AuthService.CurrentUser.Id;
                            }
                            else
                            {
                                try
                                {
                                    var authResult5 = await JSRuntime.InvokeAsync<AuthCheckResult>("checkAuth");
                                    if (authResult5 != null && authResult5.authenticated && authResult5.userId.HasValue)
                                    {
                                        userIdForBets = authResult5.userId.Value;
                                    }
                                }
                                catch { }
                            }
                        }
                        
                        var updatedBets = await GameService.GetOddEvenBetsAsync(userIdForBets);
                        await InvokeAsync(() =>
                        {
                            timeLeft = newTimeLeft;
                            currentResult = newCurrentResult;
                            bets = updatedBets;
                            lastRoundTime = DateTime.Now;
                            StateHasChanged();
                        });
                    }
                    catch { }
                });
            }
            else
            {
                // ë² íŒ… ì‹¤íŒ¨ ì‹œ ì”ì•¡ ë‹¤ì‹œ ë¡œë“œ
                await AuthService.RefreshUserAsync();
                if (AuthService.CurrentUser != null)
                {
                    balance = AuthService.CurrentUser.Balance;
                }
                StateHasChanged();
            }
        }
        catch
        {
            // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ UI ì—…ë°ì´íŠ¸
            StateHasChanged();
        }
    }

    private void NavigateToLogin()
    {
        Navigation.NavigateTo("/login");
    }

    public async ValueTask DisposeAsync()
    {
        if (timer != null)
        {
            await timer.DisposeAsync();
        }
    }
}

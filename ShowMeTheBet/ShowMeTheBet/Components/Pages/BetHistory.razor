@page "/history"
@using ShowMeTheBet.Models
@using ShowMeTheBet.Utilities
@inject ShowMeTheBet.ViewModels.Page.BetHistoryViewModel ViewModel
@inject NavigationManager Navigation
@rendermode InteractiveServer
@implements IDisposable

<PageTitle>ë² íŒ… ë‚´ì—­ - ShowMeTheBet</PageTitle>

@if (!ViewModel.IsAuthenticated)
{
    <div class="auth-required">
        <div class="auth-message">
            <h2>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h2>
            <p>ë² íŒ… ë‚´ì—­ì„ ë³´ë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>
            <button class="btn btn-primary" @onclick="NavigateToLogin">ë¡œê·¸ì¸í•˜ê¸°</button>
        </div>
    </div>
}
else
{
    <div class="history-container">
        <div class="history-header">
            <h1>ğŸ“‹ ë² íŒ… ë‚´ì—­</h1>
            <div class="balance-display">
                <span class="balance-label">ì”ì•¡:</span>
                <span class="balance-amount">@ViewModel.Balance.ToString("N0") ì›</span>
            </div>
        </div>

        @if (ViewModel.Bets == null || ViewModel.Bets.Count == 0)
        {
            <div class="empty-history">
                <p>ë² íŒ… ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        }
        else
        {
            <div class="bets-table">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ê²½ê¸°</th>
                            <th>ë² íŒ… íƒ€ì…</th>
                            <th>ë°°ë‹¹ë¥ </th>
                            <th>ë² íŒ… ê¸ˆì•¡</th>
                            <th>ì˜ˆìƒ ë‹¹ì²¨ê¸ˆ</th>
                            <th>ìƒíƒœ</th>
                            <th>ë² íŒ… ì‹œê°„</th>
                            <th>ì‘ì—…</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var bet in ViewModel.Bets)
                        {
                            <tr>
                                <td>@bet.MatchInfo</td>
                                <td>@BetDisplayUtility.GetBetTypeLabel(bet.Type)</td>
                                <td>@bet.Odds.ToString("F2")</td>
                                <td>@bet.Amount.ToString("N0") ì›</td>
                                <td>@bet.PotentialWin.ToString("N0") ì›</td>
                                <td>
                                    <span class="status-badge status-@bet.Status.ToString().ToLower()">
                                        @BetDisplayUtility.GetBetStatusLabel(bet.Status)
                                    </span>
                                </td>
                                <td>@bet.BetTime.ToString("MM/dd HH:mm")</td>
                                <td>
                                    @if (bet.Status == BetStatus.Pending)
                                    {
                                        <button class="btn btn-sm btn-danger" @onclick="() => CancelBet(bet.Id)">
                                            ì·¨ì†Œ
                                        </button>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
}

@code {
    protected override async Task OnInitializedAsync()
    {
        ViewModel.StateChanged += OnViewModelStateChanged;
        await ViewModel.InitializeAsync();
    }

    private void NavigateToLogin()
    {
        Navigation.NavigateTo("/login");
    }

    private Task CancelBet(int betId) => ViewModel.CancelBetAsync(betId);

    private void OnViewModelStateChanged() => InvokeAsync(StateHasChanged);

    public void Dispose()
    {
        ViewModel.StateChanged -= OnViewModelStateChanged;
        ViewModel.Dispose();
    }
}


@page "/history"
@using ShowMeTheBet.Models
@using ShowMeTheBet.Services
@inject BettingService BettingService
@inject AuthService AuthService
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>ë² íŒ… ë‚´ì—­ - ShowMeTheBet</PageTitle>

@if (!AuthService.IsAuthenticated)
{
    <div class="auth-required">
        <div class="auth-message">
            <h2>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h2>
            <p>ë² íŒ… ë‚´ì—­ì„ ë³´ë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>
            <button class="btn btn-primary" @onclick="NavigateToLogin">ë¡œê·¸ì¸í•˜ê¸°</button>
        </div>
    </div>
}
else
{
    <div class="history-container">
        <div class="history-header">
            <h1>ğŸ“‹ ë² íŒ… ë‚´ì—­</h1>
            <div class="balance-display">
                <span class="balance-label">ì”ì•¡:</span>
                <span class="balance-amount">@balance.ToString("N0") ì›</span>
            </div>
        </div>

        @if (bets == null || bets.Count == 0)
        {
            <div class="empty-history">
                <p>ë² íŒ… ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        }
        else
        {
            <div class="bets-table">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ê²½ê¸°</th>
                            <th>ë² íŒ… íƒ€ì…</th>
                            <th>ë°°ë‹¹ë¥ </th>
                            <th>ë² íŒ… ê¸ˆì•¡</th>
                            <th>ì˜ˆìƒ ë‹¹ì²¨ê¸ˆ</th>
                            <th>ìƒíƒœ</th>
                            <th>ë² íŒ… ì‹œê°„</th>
                            <th>ì‘ì—…</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (bets != null)
                        {
                            @foreach (var bet in bets)
                            {
                                <tr>
                                    <td>@bet.MatchInfo</td>
                                    <td>@GetBetTypeText(bet.Type)</td>
                                    <td>@bet.Odds.ToString("F2")</td>
                                    <td>@bet.Amount.ToString("N0") ì›</td>
                                    <td>@bet.PotentialWin.ToString("N0") ì›</td>
                                    <td>
                                        <span class="status-badge status-@bet.Status.ToString().ToLower()">
                                            @GetStatusText(bet.Status)
                                        </span>
                                    </td>
                                    <td>@bet.BetTime.ToString("MM/dd HH:mm")</td>
                                    <td>
                                        @if (bet.Status == BetStatus.Pending)
                                        {
                                            <button class="btn btn-sm btn-danger" @onclick="() => CancelBet(bet.Id)">
                                                ì·¨ì†Œ
                                            </button>
                                        }
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
}

@code {
    private List<Bet>? bets;
    private decimal balance = 0;

    protected override async Task OnInitializedAsync()
    {
        if (AuthService.IsAuthenticated)
        {
            bets = await BettingService.GetBetsAsync();
            balance = await BettingService.GetBalanceAsync();
        }
    }

    private string GetBetTypeText(BetType type) => type switch
    {
        BetType.Home => "í™ˆ ìŠ¹",
        BetType.Draw => "ë¬´ìŠ¹ë¶€",
        BetType.Away => "ì›ì • ìŠ¹",
        _ => ""
    };

    private string GetStatusText(BetStatus status) => status switch
    {
        BetStatus.Pending => "ëŒ€ê¸°ì¤‘",
        BetStatus.Won => "ìŠ¹ë¦¬",
        BetStatus.Lost => "íŒ¨ë°°",
        _ => ""
    };

    private async Task CancelBet(int betId)
    {
        await BettingService.RemoveBetAsync(betId);
        bets = await BettingService.GetBetsAsync();
        balance = await BettingService.GetBalanceAsync();
        StateHasChanged();
    }

    private void NavigateToLogin()
    {
        Navigation.NavigateTo("/login");
    }
}


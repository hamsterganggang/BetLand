@page "/graph"
@using ShowMeTheBet.Models
@using ShowMeTheBet.Services
@inject GameService GameService
@inject AuthService AuthService
@inject NavigationManager Navigation
@rendermode InteractiveServer
@implements IAsyncDisposable

<PageTitle>ê·¸ë˜í”„ ê²Œì„ - ShowMeTheBet</PageTitle>

@if (!AuthService.IsAuthenticated)
{
    <div class="auth-required">
        <div class="auth-message">
            <h2>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h2>
            <p>ê²Œì„ì„ í•˜ë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>
            <button class="btn btn-primary" @onclick="NavigateToLogin">ë¡œê·¸ì¸í•˜ê¸°</button>
        </div>
    </div>
}
else
{
    <div class="game-container">
        <div class="game-header">
            <h1>ğŸ“ˆ ê·¸ë˜í”„ ê²Œì„</h1>
            <div class="balance-display">
                <span class="balance-label">ì”ì•¡:</span>
                <span class="balance-amount">@balance.ToString("N0") ì›</span>
            </div>
        </div>

        <div class="game-content">
            <div class="game-main">
                <div class="graph-section">
                    <h3>í˜„ì¬ ë°°ìˆ˜</h3>
                    <div class="graph-container">
                        <svg class="graph-svg" viewBox="0 0 400 300" preserveAspectRatio="none">
                            <defs>
                                <linearGradient id="graphGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                    <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
                                </linearGradient>
                            </defs>
                            <path class="graph-line" d="@GetGraphPath()" fill="none" stroke="url(#graphGradient)" stroke-width="4" />
                            <circle class="graph-dot" cx="@(GetCurrentX())" cy="@(GetCurrentY())" r="8" fill="#667eea" />
                        </svg>
                        <div class="graph-bar-overlay" style="height: @(currentMultiplier * 20)%">
                            <div class="graph-value">x@(currentMultiplier.ToString("F2"))</div>
                        </div>
                    </div>
                    <div class="multiplier-display">
                        <span class="multiplier-label">ë°°ìˆ˜:</span>
                        <span class="multiplier-value">x@(currentMultiplier.ToString("F2"))</span>
                    </div>
                    @if (isGameRunning)
                    {
                        <div class="game-status">
                            <p class="status-text">ê²Œì„ ì§„í–‰ ì¤‘...</p>
                        </div>
                    }
                    @if (gameFailed)
                    {
                        <div class="game-status failed">
                            <p class="status-text">âŒ ê²Œì„ ì‹¤íŒ¨!</p>
                        </div>
                    }
                </div>

                <div class="bet-section">
                    <h3>ë² íŒ…í•˜ê¸°</h3>
                    <div class="bet-amount-input">
                        <label>ë² íŒ… ê¸ˆì•¡:</label>
                        <input type="number" 
                               class="form-control" 
                               value="@betAmount" 
                               @oninput="OnBetAmountInput"
                               min="1000" 
                               step="1000"
                               placeholder="ê¸ˆì•¡ ì…ë ¥"
                               disabled="@(isGameRunning || gameFailed)" />
                    </div>
                    <div class="game-controls">
                        @if (!isGameRunning && !gameFailed)
                        {
                            <button class="btn btn-success btn-start" @onclick="StartGame" disabled="@(betAmount <= 0 || isLoading)">
                                ê²Œì„ ì‹œì‘
                            </button>
                        }
                        else if (isGameRunning && !gameFailed)
                        {
                            <button class="btn btn-danger btn-stop" @onclick="StopGame" disabled="@isLoading">
                                STOP!
                            </button>
                        }
                        else if (gameFailed)
                        {
                            <button class="btn btn-primary" @onclick="ResetGame">
                                ë‹¤ì‹œ ì‹œì‘
                            </button>
                        }
                    </div>
                    @if (betAmount > 0 && (currentMultiplier > 1.0m || isGameRunning))
                    {
                        <div class="bet-summary">
                            <p>ë² íŒ… ê¸ˆì•¡: <strong>@betAmount.ToString("N0") ì›</strong></p>
                            <p>í˜„ì¬ ë°°ìˆ˜: <strong>x@(currentMultiplier.ToString("F2"))</strong></p>
                            <p>ì˜ˆìƒ ë‹¹ì²¨ê¸ˆ: <strong>@((betAmount * currentMultiplier).ToString("N0")) ì›</strong></p>
                        </div>
                    }
                </div>
            </div>

            <div class="game-history">
                <h3>ë² íŒ… ë‚´ì—­</h3>
                @if (bets == null || bets.Count == 0)
                {
                    <div class="empty-history">
                        <p>ë² íŒ… ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                }
                else
                {
                    <div class="bets-list">
                        @foreach (var bet in bets)
                        {
                            <div class="bet-item @(bet.Status == GameBetStatus.Won ? "won" : "lost")">
                                <div class="bet-info">
                                    <span class="bet-multiplier">x@(bet.Multiplier.ToString("F2"))</span>
                                    <span class="bet-amount">@bet.Amount.ToString("N0") ì›</span>
                                </div>
                                <div class="bet-result">
                                    @if (bet.Status == GameBetStatus.Won)
                                    {
                                        <span class="win-amount">+@((bet.WinAmount - bet.Amount).ToString("N0")) ì›</span>
                                    }
                                    else
                                    {
                                        <span class="lose-amount">-@bet.Amount.ToString("N0") ì›</span>
                                    }
                                </div>
                                <div class="bet-time">@bet.BetTime.ToString("HH:mm:ss")</div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
}

@code {
    private decimal balance = 0;
    private decimal currentMultiplier = 1.0m;
    private decimal betAmount = 0;
    private bool isGameRunning = false;
    private bool gameFailed = false;
    private bool isLoading = false;
    private List<GameBet>? bets;
    private System.Threading.Timer? timer;
    private System.Threading.Timer? failureCheckTimer;
    private const decimal MinMultiplier = 1.0m;
    private const decimal MaxMultiplier = 5.0m;
    private const int GameDurationSeconds = 30; // 30ì´ˆ ë™ì•ˆ 1.0 -> 5.0
    private const double FailureChancePerSecond = 0.05; // 5% í™•ë¥ 
    private DateTime gameStartTime;
    private Random random = new Random();
    private List<(double x, double y)> graphPoints = new List<(double, double)>();

    protected override async Task OnInitializedAsync()
    {
        // ì„¸ì…˜ì—ì„œ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ (ì¬ì‹œë„ ë¡œì§ í¬í•¨)
        AuthService.ResetUserLoad();
        
        // ì„¸ì…˜ ë¡œë“œë¥¼ ì—¬ëŸ¬ ë²ˆ ì‹œë„ (ìµœëŒ€ 5ë²ˆ, ë” ê¸´ ëŒ€ê¸° ì‹œê°„)
        bool isAuthenticated = false;
        for (int i = 0; i < 5; i++)
        {
            await AuthService.LoadUserFromSessionAsync();
            isAuthenticated = AuthService.IsAuthenticated;
            if (isAuthenticated)
            {
                break;
            }
            // ì²« ë²ˆì§¸ ì‹œë„ëŠ” ì§§ê²Œ, ì´í›„ëŠ” ë” ê¸¸ê²Œ ëŒ€ê¸°
            await Task.Delay(i == 0 ? 100 : 300);
        }
        
        if (isAuthenticated)
        {
            await LoadData();
        }
        else
        {
            // ë¡œê·¸ì¸ë˜ì§€ ì•Šì€ ê²½ìš° ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
            Navigation.NavigateTo("/login");
        }
    }

    private async Task LoadData()
    {
        balance = await GameService.GetBalanceAsync();
        bets = await GameService.GetGraphBetsAsync();
    }

    private void OnBetAmountInput(ChangeEventArgs e)
    {
        if (decimal.TryParse(e.Value?.ToString(), out var amount))
        {
            betAmount = amount;
            StateHasChanged();
        }
    }

    private async Task StartGame()
    {
        if (betAmount <= 0) return;

        isLoading = true;
        try
        {
            // ë¨¼ì € ë² íŒ… ê¸ˆì•¡ ì°¨ê°
            var success = await GameService.StartGraphGameAsync(betAmount);
            if (!success)
            {
                await LoadData();
                return;
            }

            // ê²Œì„ ì‹œì‘
            isGameRunning = true;
            gameFailed = false;
            currentMultiplier = MinMultiplier;
            gameStartTime = DateTime.Now;
            graphPoints.Clear();
            await LoadData();

            // ê·¸ë˜í”„ ë¶€ë“œëŸ½ê²Œ ì—…ë°ì´íŠ¸ (50msë§ˆë‹¤)
            timer = new System.Threading.Timer(async _ =>
            {
                await InvokeAsync(() =>
                {
                    if (!isGameRunning || gameFailed) return;

                    var elapsed = (DateTime.Now - gameStartTime).TotalSeconds;
                    
                    // ë°°ìˆ˜ ê³„ì‚°: 30ì´ˆ ë™ì•ˆ 1.0 -> 5.0 (ê³¡ì„ í˜• - easeOutCubic)
                    var progress = Math.Min(elapsed / GameDurationSeconds, 1.0);
                    var easedProgress = 1 - Math.Pow(1 - progress, 3); // easeOutCubic ê³¡ì„ 
                    currentMultiplier = MinMultiplier + (MaxMultiplier - MinMultiplier) * (decimal)easedProgress;

                    // ê·¸ë˜í”„ í¬ì¸íŠ¸ ì¶”ê°€ (ìµœëŒ€ 100ê°œ ìœ ì§€)
                    if (graphPoints.Count < 100)
                    {
                        graphPoints.Add((elapsed * 400 / GameDurationSeconds, 300 - (double)currentMultiplier * 60));
                    }
                    else
                    {
                        graphPoints.RemoveAt(0);
                        graphPoints.Add((elapsed * 400 / GameDurationSeconds, 300 - (double)currentMultiplier * 60));
                    }

                    if (currentMultiplier >= MaxMultiplier)
                    {
                        currentMultiplier = MaxMultiplier;
                    }

                    StateHasChanged();
                });
            }, null, TimeSpan.Zero, TimeSpan.FromMilliseconds(50));

            // ì‹¤íŒ¨ ì²´í¬ëŠ” 1ì´ˆë§ˆë‹¤
            failureCheckTimer = new System.Threading.Timer(async _ =>
            {
                await InvokeAsync(() =>
                {
                    if (!isGameRunning || gameFailed) return;

                    // 1ì´ˆë§ˆë‹¤ 5% í™•ë¥ ë¡œ ì‹¤íŒ¨
                    if (random.NextDouble() < FailureChancePerSecond)
                    {
                        // ê²Œì„ ì‹¤íŒ¨
                        gameFailed = true;
                        isGameRunning = false;
                        
                        // ì‹¤íŒ¨ ì²˜ë¦¬
                        _ = Task.Run(async () =>
                        {
                            await InvokeAsync(async () =>
                            {
                                await GameService.FailGraphGameAsync(betAmount);
                                await LoadData();
                                StateHasChanged();
                            });
                        });
                    }
                });
            }, null, TimeSpan.FromSeconds(1), TimeSpan.FromSeconds(1));
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task StopGame()
    {
        if (!isGameRunning || betAmount <= 0 || gameFailed) return;

        isGameRunning = false;
        isLoading = true;

        if (timer != null)
        {
            await timer.DisposeAsync();
            timer = null;
        }
        if (failureCheckTimer != null)
        {
            await failureCheckTimer.DisposeAsync();
            failureCheckTimer = null;
        }

        try
        {
            var success = await GameService.StopGraphGameAsync(betAmount, currentMultiplier);
            if (success)
            {
                betAmount = 0;
                currentMultiplier = MinMultiplier;
                await LoadData();
            }
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void ResetGame()
    {
        gameFailed = false;
        currentMultiplier = MinMultiplier;
        betAmount = 0;
        graphPoints.Clear();
        StateHasChanged();
    }

    private string GetGraphPath()
    {
        if (graphPoints.Count < 2) return "";

        var path = new System.Text.StringBuilder();
        path.Append($"M {graphPoints[0].x} {graphPoints[0].y}");

        for (int i = 1; i < graphPoints.Count; i++)
        {
            var prev = graphPoints[i - 1];
            var curr = graphPoints[i];
            var cp1x = prev.x + (curr.x - prev.x) / 3;
            var cp1y = prev.y;
            var cp2x = curr.x - (curr.x - prev.x) / 3;
            var cp2y = curr.y;
            path.Append($" C {cp1x} {cp1y}, {cp2x} {cp2y}, {curr.x} {curr.y}");
        }

        return path.ToString();
    }

    private double GetCurrentX()
    {
        if (graphPoints.Count == 0) return 0;
        return graphPoints[graphPoints.Count - 1].x;
    }

    private double GetCurrentY()
    {
        if (graphPoints.Count == 0) return 300;
        return graphPoints[graphPoints.Count - 1].y;
    }

    private void NavigateToLogin()
    {
        Navigation.NavigateTo("/login");
    }

    public async ValueTask DisposeAsync()
    {
        if (timer != null)
        {
            await timer.DisposeAsync();
        }
        if (failureCheckTimer != null)
        {
            await failureCheckTimer.DisposeAsync();
        }
    }
}

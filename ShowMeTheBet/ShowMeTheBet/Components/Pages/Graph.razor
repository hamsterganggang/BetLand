@page "/graph"
@using ShowMeTheBet.Models
@using ShowMeTheBet.Services
@using Microsoft.JSInterop
@inject GameService GameService
@inject AuthService AuthService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer
@implements IAsyncDisposable

<PageTitle>ê·¸ë˜í”„ ê²Œì„ - ShowMeTheBet</PageTitle>

@if (isLoading)
{
    <div style="text-align: center; padding: 50px;">
        <p>ë¡œë”© ì¤‘...</p>
    </div>
}
else if (!isAuthenticated)
{
    <div class="auth-required">
        <div class="auth-message">
            <h2>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h2>
            <p>ê²Œì„ì„ í•˜ë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>
            <button class="btn btn-primary" @onclick="NavigateToLogin">ë¡œê·¸ì¸í•˜ê¸°</button>
        </div>
    </div>
}
else
{
    <div class="game-container">
        <div class="game-header">
            <h1>ğŸ“ˆ ê·¸ë˜í”„ ê²Œì„</h1>
            <div class="balance-display">
                <span class="balance-label">ì”ì•¡:</span>
                <span class="balance-amount">@balance.ToString("N0") ì›</span>
            </div>
        </div>

        <div class="game-content">
            <div class="game-main">
                <div class="graph-section">
                    <h3>í˜„ì¬ ë°°ìˆ˜</h3>
                    <div class="graph-container">
                        <svg class="graph-svg" viewBox="0 0 400 300" preserveAspectRatio="none">
                            <defs>
                                <linearGradient id="graphGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                    <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
                                </linearGradient>
                            </defs>
                            <path class="graph-line" d="@GetGraphPath()" fill="none" stroke="url(#graphGradient)" stroke-width="4" />
                            <circle class="graph-dot" cx="@(GetCurrentX())" cy="@(GetCurrentY())" r="8" fill="#667eea" />
                        </svg>
                        <div class="graph-bar-overlay" style="height: @(currentMultiplier * 20)%">
                            <div class="graph-value">x@(currentMultiplier.ToString("F2"))</div>
                        </div>
                    </div>
                    <div class="multiplier-display">
                        <span class="multiplier-label">ë°°ìˆ˜:</span>
                        <span class="multiplier-value">x@(currentMultiplier.ToString("F2"))</span>
                    </div>
                    @if (isGameRunning)
                    {
                        <div class="game-status">
                            <p class="status-text">ê²Œì„ ì§„í–‰ ì¤‘...</p>
                        </div>
                    }
                    @if (gameFailed)
                    {
                        <div class="game-status failed">
                            <p class="status-text">âŒ ê²Œì„ ì‹¤íŒ¨!</p>
                        </div>
                    }
                </div>

                <div class="bet-section">
                    <h3>ë² íŒ…í•˜ê¸°</h3>
                    <div class="bet-amount-input">
                        <label>ë² íŒ… ê¸ˆì•¡:</label>
                        <input type="number" 
                               class="form-control" 
                               value="@betAmount" 
                               @oninput="OnBetAmountInput"
                               min="1000" 
                               step="1000"
                               placeholder="ê¸ˆì•¡ ì…ë ¥"
                               disabled="@(isGameRunning || gameFailed)" />
                        <div class="quick-amount-buttons">
                            <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="async () => await SetBetAmount(0.25m)" disabled="@(balance <= 0 || isGameRunning || gameFailed || isLoading)">
                                25%
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="async () => await SetBetAmount(0.50m)" disabled="@(balance <= 0 || isGameRunning || gameFailed || isLoading)">
                                50%
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="async () => await SetBetAmount(0.75m)" disabled="@(balance <= 0 || isGameRunning || gameFailed || isLoading)">
                                75%
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="async () => await SetBetAmount(1.00m)" disabled="@(balance <= 0 || isGameRunning || gameFailed || isLoading)">
                                100%
                            </button>
                        </div>
                    </div>
                    <div class="game-controls">
                        @if (!isGameRunning && !gameFailed)
                        {
                            <button class="btn btn-success btn-start" @onclick="async () => await StartGame()" disabled="@(betAmount < 1000 || isLoading || (balance > 0 && balance < betAmount))">
                                ê²Œì„ ì‹œì‘
                            </button>
                        }
                        else if (isGameRunning && !gameFailed)
                        {
                            <button class="btn btn-danger btn-stop" @onclick="StopGame" disabled="@isLoading">
                                STOP!
                            </button>
                        }
                        else if (gameFailed)
                        {
                            <button class="btn btn-primary" @onclick="ResetGame">
                                ë‹¤ì‹œ ì‹œì‘
                            </button>
                        }
                    </div>
                    @if (betAmount > 0 && (currentMultiplier > 1.0m || isGameRunning))
                    {
                        <div class="bet-summary">
                            <p>ë² íŒ… ê¸ˆì•¡: <strong>@betAmount.ToString("N0") ì›</strong></p>
                            <p>í˜„ì¬ ë°°ìˆ˜: <strong>x@(currentMultiplier.ToString("F2"))</strong></p>
                            <p>ì˜ˆìƒ ë‹¹ì²¨ê¸ˆ: <strong>@((betAmount * currentMultiplier).ToString("N0")) ì›</strong></p>
                        </div>
                    }
                </div>
            </div>

            <div class="game-history">
                <h3>ë² íŒ… ë‚´ì—­</h3>
                @if (bets == null || bets.Count == 0)
                {
                    <div class="empty-history">
                        <p>ë² íŒ… ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                }
                else
                {
                    <div class="bets-list">
                        @foreach (var bet in bets)
                        {
                            <div class="bet-item @(bet.Status == GameBetStatus.Won ? "won" : "lost")">
                                <div class="bet-info">
                                    <span class="bet-multiplier">x@(bet.Multiplier.ToString("F2"))</span>
                                    <span class="bet-amount">@bet.Amount.ToString("N0") ì›</span>
                                </div>
                                <div class="bet-result">
                                    @if (bet.Status == GameBetStatus.Won)
                                    {
                                        <span class="win-amount">+@((bet.WinAmount - bet.Amount).ToString("N0")) ì›</span>
                                    }
                                    else
                                    {
                                        <span class="lose-amount">-@bet.Amount.ToString("N0") ì›</span>
                                    }
                                </div>
                                <div class="bet-time">@bet.BetTime.ToString("HH:mm:ss")</div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
}

@code {
    private decimal balance = 0;
    private decimal currentMultiplier = 1.0m;
    private decimal betAmount = 0;
    private bool isGameRunning = false;
    private bool gameFailed = false;
    private bool isLoading = true;
    private bool isAuthenticated = false;
    private List<GameBet>? bets;
    private System.Threading.Timer? timer;
    private System.Threading.Timer? failureCheckTimer;
    private const decimal MinMultiplier = 1.0m;
    private const decimal MaxMultiplier = 5.0m;
    private const int GameDurationSeconds = 30; // 30ì´ˆ ë™ì•ˆ 1.0 -> 5.0
    private const double FailureChancePerSecond = 0.05; // 5% í™•ë¥ 
    private DateTime gameStartTime;
    private Random random = new Random();
    private List<(double x, double y)> graphPoints = new List<(double, double)>();

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        StateHasChanged();
        
        try
        {
            // ì‹¤ì„œë²„(IIS)ì—ì„œ SignalR ì—°ê²°ì˜ HttpContext ì ‘ê·¼ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´
            // JavaScript Interopì„ í†µí•´ APIë¥¼ í˜¸ì¶œí•˜ì—¬ ì¸ì¦ ìƒíƒœ í™•ì¸
            try
            {
                var authResult = await JSRuntime.InvokeAsync<AuthCheckResult>("checkAuth");
                if (authResult != null && authResult.authenticated && authResult.userId.HasValue)
                {
                    // API ì‘ë‹µì„ ê¸°ë°˜ìœ¼ë¡œ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
                    await AuthService.LoadUserByIdAsync(authResult.userId.Value);
                    isAuthenticated = true;
                    // API ì‘ë‹µì˜ balanceë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜, RefreshUserAsync í›„ GetBalanceAsync í˜¸ì¶œ
                    if (authResult.balance.HasValue)
                    {
                        balance = authResult.balance.Value;
                    }
                    else
                    {
                        await AuthService.RefreshUserAsync();
                        balance = await GameService.GetBalanceAsync();
                    }
                    // ë‚˜ë¨¸ì§€ ë°ì´í„° ë¡œë“œ
                    bets = await GameService.GetGraphBetsAsync(authResult.userId.Value);
                }
                else
                {
                    // API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ì§ì ‘ í™•ì¸ (ë¡œì»¬ í™˜ê²½ ëŒ€ë¹„)
                    AuthService.ResetUserLoad();
                    await AuthService.LoadUserFromSessionAsync();
                    var user = AuthService.CurrentUser;
                    isAuthenticated = user != null;
                    
                    if (isAuthenticated)
                    {
                        await AuthService.RefreshUserAsync();
                        balance = await GameService.GetBalanceAsync();
                        // userId ê°€ì ¸ì˜¤ê¸°
                        int? userId = null;
                        if (AuthService.CurrentUser != null)
                        {
                            userId = AuthService.CurrentUser.Id;
                        }
                        else
                        {
                            try
                            {
                                var authResult2 = await JSRuntime.InvokeAsync<AuthCheckResult>("checkAuth");
                                if (authResult2 != null && authResult2.authenticated && authResult2.userId.HasValue)
                                {
                                    userId = authResult2.userId.Value;
                                }
                            }
                            catch { }
                        }
                        bets = await GameService.GetGraphBetsAsync(userId);
                    }
                }
            }
            catch
            {
                // API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ì§ì ‘ í™•ì¸
                AuthService.ResetUserLoad();
                await AuthService.LoadUserFromSessionAsync();
                var user = AuthService.CurrentUser;
                isAuthenticated = user != null;
                
                if (isAuthenticated)
                {
                    await AuthService.RefreshUserAsync();
                    balance = await GameService.GetBalanceAsync();
                    // userId ê°€ì ¸ì˜¤ê¸°
                    int? userId2 = null;
                    if (AuthService.CurrentUser != null)
                    {
                        userId2 = AuthService.CurrentUser.Id;
                    }
                    else
                    {
                        try
                        {
                            var authResult3 = await JSRuntime.InvokeAsync<AuthCheckResult>("checkAuth");
                            if (authResult3 != null && authResult3.authenticated && authResult3.userId.HasValue)
                            {
                                userId2 = authResult3.userId.Value;
                            }
                        }
                        catch { }
                    }
                    bets = await GameService.GetGraphBetsAsync(userId2);
                }
            }
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !isAuthenticated)
        {
            // ì²« ë Œë”ë§ í›„ì—ë„ ì¸ì¦ ìƒíƒœë¥¼ ë‹¤ì‹œ í™•ì¸ (SignalR ì—°ê²° í›„ HttpContextê°€ ì„¤ì •ë  ìˆ˜ ìˆìŒ)
            await CheckAuthAndLoadData();
        }
    }

    private async Task CheckAuthAndLoadData()
    {
        try
        {
            var authResult = await JSRuntime.InvokeAsync<AuthCheckResult>("checkAuth");
            if (authResult != null && authResult.authenticated && authResult.userId.HasValue)
            {
                var wasAuthenticated = isAuthenticated;
                await AuthService.LoadUserByIdAsync(authResult.userId.Value);
                isAuthenticated = true;
                
                if (!wasAuthenticated)
                {
                    // API ì‘ë‹µì˜ balanceë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜, RefreshUserAsync í›„ GetBalanceAsync í˜¸ì¶œ
                    if (authResult.balance.HasValue)
                    {
                        balance = authResult.balance.Value;
                    }
                    else
                    {
                        await AuthService.RefreshUserAsync();
                        balance = await GameService.GetBalanceAsync();
                    }
                    // userId ê°€ì ¸ì˜¤ê¸°
                    int? userId4 = null;
                    if (AuthService.CurrentUser != null)
                    {
                        userId4 = AuthService.CurrentUser.Id;
                    }
                    else
                    {
                        try
                        {
                            var authResult4 = await JSRuntime.InvokeAsync<AuthCheckResult>("checkAuth");
                            if (authResult4 != null && authResult4.authenticated && authResult4.userId.HasValue)
                            {
                                userId4 = authResult4.userId.Value;
                            }
                        }
                        catch { }
                    }
                    bets = await GameService.GetGraphBetsAsync(userId4);
                    StateHasChanged();
                }
            }
        }
        catch { }
    }

    private class AuthCheckResult
    {
        public bool success { get; set; }
        public bool authenticated { get; set; }
        public int? userId { get; set; }
        public string? username { get; set; }
        public decimal? balance { get; set; }
    }

    private async Task LoadData()
    {
        // ì‚¬ìš©ì ì •ë³´ë¥¼ ìµœì‹ í™”í•œ í›„ ì”ì•¡ ë¡œë“œ
        await AuthService.RefreshUserAsync();
        if (AuthService.CurrentUser != null)
        {
            balance = AuthService.CurrentUser.Balance;
        }
        else
        {
            balance = await GameService.GetBalanceAsync();
        }
        // userId ê°€ì ¸ì˜¤ê¸°
        int? userId5 = null;
        if (AuthService.CurrentUser != null)
        {
            userId5 = AuthService.CurrentUser.Id;
        }
        else
        {
            try
            {
                var authResult5 = await JSRuntime.InvokeAsync<AuthCheckResult>("checkAuth");
                if (authResult5 != null && authResult5.authenticated && authResult5.userId.HasValue)
                {
                    userId5 = authResult5.userId.Value;
                }
            }
            catch { }
        }
        bets = await GameService.GetGraphBetsAsync(userId5);
        StateHasChanged();
    }

    private void OnBetAmountInput(ChangeEventArgs e)
    {
        if (decimal.TryParse(e.Value?.ToString(), out var amount))
        {
            betAmount = amount;
            StateHasChanged();
        }
    }

    private async Task SetBetAmount(decimal percentage)
    {
        try
        {
            // JavaScript ì½˜ì†”ì— ë¡œê·¸ ì¶œë ¥ (ë””ë²„ê¹…ìš©)
            await JSRuntime.InvokeVoidAsync("console.log", $"SetBetAmount í˜¸ì¶œ: {percentage * 100}%");
            await JSRuntime.InvokeVoidAsync("console.log", $"í˜„ì¬ balance ë³€ìˆ˜ ê°’: {balance}");
        }
        catch { }

        try
        {
            // í˜„ì¬ ì”ì•¡ì„ ë¨¼ì € í™•ì¸ (RefreshUserAsync í˜¸ì¶œ ì „)
            decimal currentBalance = balance;
            
            // CurrentUserê°€ ì—†ìœ¼ë©´ ë¡œë“œ ì‹œë„
            if (AuthService.CurrentUser == null)
            {
                await AuthService.LoadUserFromSessionAsync();
            }
            
            // CurrentUserê°€ ìˆìœ¼ë©´ ì”ì•¡ í™•ì¸
            if (AuthService.CurrentUser != null)
            {
                // RefreshUserAsyncë¥¼ í˜¸ì¶œí•˜ì§€ ì•Šê³  í˜„ì¬ ì”ì•¡ ì‚¬ìš©
                // (RefreshUserAsyncê°€ ì”ì•¡ì„ 0ìœ¼ë¡œ ë§Œë“¤ ìˆ˜ ìˆìŒ)
                currentBalance = AuthService.CurrentUser.Balance;
                
                try
                {
                    await JSRuntime.InvokeVoidAsync("console.log", $"CurrentUser.Balance: {currentBalance}");
                }
                catch { }
            }
            else
            {
                // CurrentUserê°€ ì—†ìœ¼ë©´ APIë¥¼ í†µí•´ ì”ì•¡ ê°€ì ¸ì˜¤ê¸°
                try
                {
                    var authResult = await JSRuntime.InvokeAsync<AuthCheckResult>("checkAuth");
                    if (authResult != null && authResult.authenticated && authResult.balance.HasValue)
                    {
                        currentBalance = authResult.balance.Value;
                        await JSRuntime.InvokeVoidAsync("console.log", $"APIì—ì„œ ê°€ì ¸ì˜¨ ì”ì•¡: {currentBalance}");
                    }
                }
                catch { }
            }
            
            // ì”ì•¡ì´ 0ì´ë©´ RefreshUserAsync ì‹œë„ (ìµœí›„ì˜ ìˆ˜ë‹¨)
            if (currentBalance <= 0)
            {
                await AuthService.RefreshUserAsync();
                if (AuthService.CurrentUser != null)
                {
                    currentBalance = AuthService.CurrentUser.Balance;
                }
            }
            
            balance = currentBalance;
            
            try
            {
                await JSRuntime.InvokeVoidAsync("console.log", $"ìµœì¢… ì”ì•¡: {balance}, ì„¤ì •í•  ë¹„ìœ¨: {percentage * 100}%");
            }
            catch { }
            
            if (balance > 0)
            {
                betAmount = Math.Floor(balance * percentage / 1000) * 1000; // 1000ì› ë‹¨ìœ„ë¡œ ë‚´ë¦¼
                if (betAmount < 1000) betAmount = 1000; // ìµœì†Œ 1000ì›
                
                try
                {
                    await JSRuntime.InvokeVoidAsync("console.log", $"ì„¤ì •ëœ ë² íŒ… ê¸ˆì•¡: {betAmount}");
                }
                catch { }
                
                StateHasChanged();
            }
            else
            {
                try
                {
                    await JSRuntime.InvokeVoidAsync("console.error", "ì”ì•¡ì´ 0ì›ì…ë‹ˆë‹¤");
                }
                catch { }
            }
        }
        catch (Exception ex)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("console.error", $"SetBetAmount ì˜¤ë¥˜: {ex.Message}");
            }
            catch { }
        }
    }

    private async Task StartGame()
    {
        // JavaScript ì½˜ì†”ì— ë¡œê·¸ ì¶œë ¥ (ë””ë²„ê¹…ìš©)
        try
        {
            await JSRuntime.InvokeVoidAsync("console.log", "=== StartGame ë©”ì„œë“œ í˜¸ì¶œë¨ ===");
            await JSRuntime.InvokeVoidAsync("console.log", $"ë² íŒ… ê¸ˆì•¡: {betAmount}, í˜„ì¬ ì”ì•¡: {balance}");
        }
        catch { }

        if (betAmount < 1000) 
        {
            // ìµœì†Œ ë² íŒ… ê¸ˆì•¡ ì²´í¬
            try
            {
                await JSRuntime.InvokeVoidAsync("console.error", "ë² íŒ… ê¸ˆì•¡ì´ 1000ì› ë¯¸ë§Œì…ë‹ˆë‹¤");
            }
            catch { }
            return;
        }

        try
        {
            // ë² íŒ… ì „ì— ì‚¬ìš©ì ì •ë³´ ë‹¤ì‹œ ë¡œë“œ - ì—¬ëŸ¬ ë°©ë²•ìœ¼ë¡œ ì‹œë„
            if (AuthService.CurrentUser == null)
            {
                try
                {
                    await JSRuntime.InvokeVoidAsync("console.log", "CurrentUserê°€ null, ì„¸ì…˜ì—ì„œ ë¡œë“œ ì‹œë„");
                }
                catch { }
                
                // 1. ì„¸ì…˜ì—ì„œ ë¡œë“œ ì‹œë„
                await AuthService.LoadUserFromSessionAsync();
                
                // 2. ì—¬ì „íˆ nullì´ë©´ APIë¥¼ í†µí•´ ë¡œë“œ
                if (AuthService.CurrentUser == null)
                {
                    try
                    {
                        await JSRuntime.InvokeVoidAsync("console.log", "APIë¥¼ í†µí•´ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹œë„");
                        var authResult = await JSRuntime.InvokeAsync<AuthCheckResult>("checkAuth");
                        if (authResult != null && authResult.authenticated && authResult.userId.HasValue)
                        {
                            var loadSuccess = await AuthService.LoadUserByIdAsync(authResult.userId.Value);
                            await Task.Delay(50); // SignalR ë™ê¸°í™” ëŒ€ê¸°
                            try
                            {
                                await JSRuntime.InvokeVoidAsync("console.log", $"LoadUserByIdAsync ê²°ê³¼: {loadSuccess}, CurrentUser: {(AuthService.CurrentUser != null ? AuthService.CurrentUser.Username : "null")}");
                            }
                            catch { }
                        }
                    }
                    catch { }
                }
            }
            
            // ì”ì•¡ í™•ì¸ - RefreshUserAsync í˜¸ì¶œ ì „ì— í˜„ì¬ ì”ì•¡ í™•ì¸
            decimal currentBalance = balance;
            
            // CurrentUserê°€ ìˆìœ¼ë©´ ì”ì•¡ í™•ì¸ (RefreshUserAsync í˜¸ì¶œ ì „)
            if (AuthService.CurrentUser != null)
            {
                currentBalance = AuthService.CurrentUser.Balance;
            }
            else
            {
                // CurrentUserê°€ ì—†ìœ¼ë©´ APIë¥¼ í†µí•´ ì”ì•¡ ê°€ì ¸ì˜¤ê¸°
                try
                {
                    var authResult = await JSRuntime.InvokeAsync<AuthCheckResult>("checkAuth");
                    if (authResult != null && authResult.authenticated && authResult.balance.HasValue)
                    {
                        currentBalance = authResult.balance.Value;
                        // ì‚¬ìš©ì ì •ë³´ë„ ë¡œë“œ
                        if (authResult.userId.HasValue)
                        {
                            await AuthService.LoadUserByIdAsync(authResult.userId.Value);
                        }
                    }
                }
                catch { }
            }
            
            // ì”ì•¡ì´ 0ì´ê±°ë‚˜ ë¶€ì¡±í•˜ë©´ RefreshUserAsync ì‹œë„
            if (currentBalance <= 0 || currentBalance < betAmount)
            {
                await AuthService.RefreshUserAsync();
                if (AuthService.CurrentUser != null)
                {
                    var refreshedBalance = AuthService.CurrentUser.Balance;
                    if (refreshedBalance > 0)
                    {
                        currentBalance = refreshedBalance;
                    }
                }
            }
            
            try
            {
                await JSRuntime.InvokeVoidAsync("console.log", $"í˜„ì¬ ì”ì•¡: {currentBalance}, ë² íŒ… ê¸ˆì•¡: {betAmount}");
            }
            catch { }
            
            // ì‚¬ìš©ì ì •ë³´ê°€ ì—¬ì „íˆ ì—†ìœ¼ë©´ ì¬ì‹œë„
            if (AuthService.CurrentUser == null)
            {
                try
                {
                    await JSRuntime.InvokeVoidAsync("console.warn", "ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ, ì¬ì‹œë„ ì¤‘...");
                }
                catch { }
                
                // ìµœì¢… ì¬ì‹œë„: APIë¥¼ í†µí•´ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
                try
                {
                    var authResult = await JSRuntime.InvokeAsync<AuthCheckResult>("checkAuth");
                    if (authResult != null && authResult.authenticated && authResult.userId.HasValue)
                    {
                        var loadSuccess = await AuthService.LoadUserByIdAsync(authResult.userId.Value);
                        try
                        {
                            await JSRuntime.InvokeVoidAsync("console.log", $"LoadUserByIdAsync ê²°ê³¼: {loadSuccess}, UserId: {authResult.userId.Value}");
                        }
                        catch { }
                        
                        // LoadUserByIdAsync í›„ ì•½ê°„ì˜ ì§€ì—° (SignalR ë™ê¸°í™” ëŒ€ê¸°)
                        await Task.Delay(50);
                        
                        // CurrentUserë¥¼ ë‹¤ì‹œ í™•ì¸
                        if (AuthService.CurrentUser != null)
                        {
                            currentBalance = AuthService.CurrentUser.Balance;
                            try
                            {
                                await JSRuntime.InvokeVoidAsync("console.log", $"ì¬ì‹œë„ í›„ ì‚¬ìš©ì ë¡œë“œ ì„±ê³µ: {AuthService.CurrentUser.Username}, ì”ì•¡: {currentBalance}");
                            }
                            catch { }
                        }
                        else if (authResult.balance.HasValue)
                        {
                            // CurrentUserê°€ ì—¬ì „íˆ nullì´ì§€ë§Œ APIì—ì„œ ì”ì•¡ì„ ë°›ì•˜ìœ¼ë©´ ì‚¬ìš©
                            currentBalance = authResult.balance.Value;
                            try
                            {
                                await JSRuntime.InvokeVoidAsync("console.warn", $"CurrentUserëŠ” nullì´ì§€ë§Œ API ì”ì•¡ ì‚¬ìš©: {currentBalance}");
                            }
                            catch { }
                        }
                    }
                }
                catch (Exception ex)
                {
                    try
                    {
                        await JSRuntime.InvokeVoidAsync("console.error", $"ì¬ì‹œë„ ì¤‘ ì˜¤ë¥˜: {ex.Message}");
                    }
                    catch { }
                }
                
                // ì‚¬ìš©ì ì •ë³´ê°€ ì—†ì–´ë„ APIì—ì„œ userIdë¥¼ ë°›ì•˜ìœ¼ë©´ ê³„ì† ì§„í–‰
                // GameServiceê°€ ì¿ í‚¤ì—ì„œ ì§ì ‘ userIdë¥¼ ì½ì„ ìˆ˜ ìˆìŒ
                if (AuthService.CurrentUser == null)
                {
                    // APIì—ì„œ userIdë¥¼ ë°›ì•˜ëŠ”ì§€ í™•ì¸
                    try
                    {
                        var authResult = await JSRuntime.InvokeAsync<AuthCheckResult>("checkAuth");
                        if (authResult != null && authResult.authenticated && authResult.userId.HasValue)
                        {
                            // APIì—ì„œ ì¸ì¦ ì •ë³´ë¥¼ ë°›ì•˜ìœ¼ë©´ ê³„ì† ì§„í–‰ (GameServiceê°€ ì¿ í‚¤ì—ì„œ userIdë¥¼ ì½ìŒ)
                            try
                            {
                                await JSRuntime.InvokeVoidAsync("console.log", $"CurrentUserëŠ” nullì´ì§€ë§Œ API ì¸ì¦ í™•ì¸ë¨, ê²Œì„ ì§„í–‰: UserId {authResult.userId.Value}");
                            }
                            catch { }
                        }
                        else
                        {
                            // APIì—ì„œë„ ì¸ì¦ ì •ë³´ë¥¼ ë°›ì§€ ëª»í–ˆìœ¼ë©´ ì—ëŸ¬
                            try
                            {
                                await JSRuntime.InvokeVoidAsync("console.error", "ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
                            }
                            catch { }
                            isLoading = false;
                            await LoadData();
                            StateHasChanged();
                            return;
                        }
                    }
                    catch
                    {
                        // API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬
                        try
                        {
                            await JSRuntime.InvokeVoidAsync("console.error", "ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
                        }
                        catch { }
                        isLoading = false;
                        await LoadData();
                        StateHasChanged();
                        return;
                    }
                }
            }
            
            if (currentBalance < betAmount)
            {
                try
                {
                    await JSRuntime.InvokeVoidAsync("console.error", $"ì”ì•¡ ë¶€ì¡±: {currentBalance} < {betAmount}");
                }
                catch { }
                isLoading = false;
                balance = currentBalance;
                await LoadData();
                StateHasChanged();
                return;
            }
            
            // ë¨¼ì € ë² íŒ… ê¸ˆì•¡ ì°¨ê°
            try
            {
                await JSRuntime.InvokeVoidAsync("console.log", "ë² íŒ… ê¸ˆì•¡ ì°¨ê° ì‹œì‘");
            }
            catch { }
            
            // APIì—ì„œ userId ê°€ì ¸ì˜¤ê¸° (CurrentUserê°€ nullì¸ ê²½ìš°)
            int? userId = null;
            if (AuthService.CurrentUser != null)
            {
                userId = AuthService.CurrentUser.Id;
            }
            else
            {
                try
                {
                    var authResult = await JSRuntime.InvokeAsync<AuthCheckResult>("checkAuth");
                    if (authResult != null && authResult.authenticated && authResult.userId.HasValue)
                    {
                        userId = authResult.userId.Value;
                        try
                        {
                            await JSRuntime.InvokeVoidAsync("console.log", $"APIì—ì„œ userId ê°€ì ¸ì˜´: {userId.Value}");
                        }
                        catch { }
                    }
                }
                catch { }
            }
            
            bool success = false;
            try
            {
                success = await GameService.StartGraphGameAsync(betAmount, userId);
                try
                {
                    await JSRuntime.InvokeVoidAsync("console.log", $"ë² íŒ… ê²°ê³¼: {success}");
                }
                catch { }
            }
            catch (Exception ex)
            {
                try
                {
                    await JSRuntime.InvokeVoidAsync("console.error", $"ë² íŒ… ì¤‘ ì˜ˆì™¸ ë°œìƒ: {ex.Message}");
                }
                catch { }
                isLoading = false;
                await LoadData();
                StateHasChanged();
                return;
            }
            
            if (!success)
            {
                try
                {
                    await JSRuntime.InvokeVoidAsync("console.error", "ë² íŒ… ì‹¤íŒ¨ - GameService.StartGraphGameAsyncê°€ falseë¥¼ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤. ì„œë²„ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
                }
                catch { }
                isLoading = false;
                await LoadData();
                StateHasChanged();
                return;
            }

            // ê²Œì„ ì‹œì‘ - ì¦‰ì‹œ ì‹œì‘
            isGameRunning = true;
            gameFailed = false;
            currentMultiplier = MinMultiplier;
            gameStartTime = DateTime.Now;
            graphPoints.Clear();
            
            // ì”ì•¡ ì¦‰ì‹œ ì°¨ê° (ë² íŒ… ê¸ˆì•¡ë§Œí¼)
            balance -= betAmount;
            
            // ì”ì•¡ ì—…ë°ì´íŠ¸ì™€ ë² íŒ… ë‚´ì—­ì€ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì²˜ë¦¬
            _ = Task.Run(async () =>
            {
                try
                {
                    // ì”ì•¡ ì—…ë°ì´íŠ¸ (ë² íŒ… í›„ ì°¨ê°ëœ ì”ì•¡) - DBì—ì„œ ìµœì‹  ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                    await AuthService.RefreshUserAsync();
                    if (AuthService.CurrentUser != null)
                    {
                        await InvokeAsync(() =>
                        {
                            balance = AuthService.CurrentUser.Balance;
                            StateHasChanged();
                        });
                    }
                    
                    // ë² íŒ… ë‚´ì—­ ì—…ë°ì´íŠ¸
                    int? userId6 = null;
                    if (AuthService.CurrentUser != null)
                    {
                        userId6 = AuthService.CurrentUser.Id;
                    }
                    else
                    {
                        try
                        {
                            var authResult6 = await JSRuntime.InvokeAsync<AuthCheckResult>("checkAuth");
                            if (authResult6 != null && authResult6.authenticated && authResult6.userId.HasValue)
                            {
                                userId6 = authResult6.userId.Value;
                            }
                        }
                        catch { }
                    }
                    
                    var updatedBets = await GameService.GetGraphBetsAsync(userId6);
                    await InvokeAsync(() =>
                    {
                        bets = updatedBets;
                        StateHasChanged();
                    });
                }
                catch { }
            });
            
            StateHasChanged();

            // ê·¸ë˜í”„ ë¶€ë“œëŸ½ê²Œ ì—…ë°ì´íŠ¸ (50msë§ˆë‹¤)
            timer = new System.Threading.Timer(async _ =>
            {
                try
                {
                    await InvokeAsync(() =>
                    {
                        if (!isGameRunning || gameFailed) return;

                        var elapsed = (DateTime.Now - gameStartTime).TotalSeconds;
                        
                        // ë°°ìˆ˜ ê³„ì‚°: 30ì´ˆ ë™ì•ˆ 1.0 -> 5.0 (ê³¡ì„ í˜• - easeOutCubic)
                        var progress = Math.Min(elapsed / GameDurationSeconds, 1.0);
                        var easedProgress = 1 - Math.Pow(1 - progress, 3); // easeOutCubic ê³¡ì„ 
                        currentMultiplier = MinMultiplier + (MaxMultiplier - MinMultiplier) * (decimal)easedProgress;

                        // ê·¸ë˜í”„ í¬ì¸íŠ¸ ì¶”ê°€ (ìµœëŒ€ 100ê°œ ìœ ì§€)
                        if (graphPoints.Count < 100)
                        {
                            graphPoints.Add((elapsed * 400 / GameDurationSeconds, 300 - (double)currentMultiplier * 60));
                        }
                        else
                        {
                            graphPoints.RemoveAt(0);
                            graphPoints.Add((elapsed * 400 / GameDurationSeconds, 300 - (double)currentMultiplier * 60));
                        }

                        if (currentMultiplier >= MaxMultiplier)
                        {
                            currentMultiplier = MaxMultiplier;
                        }

                        StateHasChanged();
                    });
                }
                catch
                {
                    // SignalR ì—°ê²° ì˜¤ë¥˜ ì‹œ ë¬´ì‹œ
                }
            }, null, TimeSpan.Zero, TimeSpan.FromMilliseconds(50));

            // ì‹¤íŒ¨ ì²´í¬ëŠ” 1ì´ˆë§ˆë‹¤
            failureCheckTimer = new System.Threading.Timer(async _ =>
            {
                try
                {
                    await InvokeAsync(() =>
                    {
                        if (!isGameRunning || gameFailed) return;

                        // 1ì´ˆë§ˆë‹¤ 5% í™•ë¥ ë¡œ ì‹¤íŒ¨
                        if (random.NextDouble() < FailureChancePerSecond)
                        {
                            // ê²Œì„ ì‹¤íŒ¨
                            gameFailed = true;
                            isGameRunning = false;
                            
                            // ì‹¤íŒ¨ ì²˜ë¦¬ - ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸
                            StateHasChanged();
                            
                            // ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì„œë²„ ì²˜ë¦¬ ë° ì •í™•í•œ ì”ì•¡ ì—…ë°ì´íŠ¸
                            _ = Task.Run(async () =>
                            {
                                try
                                {
                                    await GameService.FailGraphGameAsync(betAmount);
                                    
                                    // ì”ì•¡ ì—…ë°ì´íŠ¸ (ì‹¤íŒ¨ í›„ ì”ì•¡ì€ ì´ë¯¸ ì°¨ê°ë¨)
                                    await AuthService.RefreshUserAsync();
                                    if (AuthService.CurrentUser != null)
                                    {
                                        await InvokeAsync(() =>
                                        {
                                            balance = AuthService.CurrentUser.Balance;
                                            StateHasChanged();
                                        });
                                    }
                                    
                                    // ë‚˜ë¨¸ì§€ ë°ì´í„° ë¡œë“œ
                                    int? userId7 = null;
                                    if (AuthService.CurrentUser != null)
                                    {
                                        userId7 = AuthService.CurrentUser.Id;
                                    }
                                    else
                                    {
                                        try
                                        {
                                            var authResult7 = await JSRuntime.InvokeAsync<AuthCheckResult>("checkAuth");
                                            if (authResult7 != null && authResult7.authenticated && authResult7.userId.HasValue)
                                            {
                                                userId7 = authResult7.userId.Value;
                                            }
                                        }
                                        catch { }
                                    }
                                    
                                    var updatedBets = await GameService.GetGraphBetsAsync(userId7);
                                    await InvokeAsync(() =>
                                    {
                                        bets = updatedBets;
                                        StateHasChanged();
                                    });
                                }
                                catch
                                {
                                    // SignalR ì—°ê²° ì˜¤ë¥˜ ì‹œ ë¬´ì‹œ
                                }
                            });
                        }
                    });
                }
                catch
                {
                    // SignalR ì—°ê²° ì˜¤ë¥˜ ì‹œ ë¬´ì‹œ
                }
            }, null, TimeSpan.FromSeconds(1), TimeSpan.FromSeconds(1));
        }
        catch (Exception ex)
        {
            // ì—ëŸ¬ ë°œìƒ ì‹œ ë¡œê·¸ ì¶œë ¥
            try
            {
                await JSRuntime.InvokeVoidAsync("console.error", $"StartGame ì˜¤ë¥˜: {ex.Message}");
            }
            catch { }
            
            // ì—ëŸ¬ ë°œìƒ ì‹œ ê²Œì„ ìƒíƒœ ì´ˆê¸°í™”
            isGameRunning = false;
            gameFailed = false;
            StateHasChanged();
        }
    }

    private async Task StopGame()
    {
        if (!isGameRunning || betAmount <= 0 || gameFailed) return;

        isGameRunning = false;

        if (timer != null)
        {
            await timer.DisposeAsync();
            timer = null;
        }
        if (failureCheckTimer != null)
        {
            await failureCheckTimer.DisposeAsync();
            failureCheckTimer = null;
        }

        try
        {
            // ë² íŒ… ì „ì— ì‚¬ìš©ì ì •ë³´ ë‹¤ì‹œ ë¡œë“œ
            if (AuthService.CurrentUser == null)
            {
                await AuthService.LoadUserFromSessionAsync();
            }
            
            // userId ê°€ì ¸ì˜¤ê¸°
            int? userId = null;
            if (AuthService.CurrentUser != null)
            {
                userId = AuthService.CurrentUser.Id;
            }
            else
            {
                try
                {
                    var authResult = await JSRuntime.InvokeAsync<AuthCheckResult>("checkAuth");
                    if (authResult != null && authResult.authenticated && authResult.userId.HasValue)
                    {
                        userId = authResult.userId.Value;
                    }
                }
                catch { }
            }
            
            var winAmount = betAmount * currentMultiplier;
            var success = await GameService.StopGraphGameAsync(betAmount, currentMultiplier, userId);
            if (success)
            {
                betAmount = 0;
                currentMultiplier = MinMultiplier;
                
                // ì”ì•¡ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ (ìŠ¹ë¦¬ ê¸ˆì•¡ ì¶”ê°€)
                balance += winAmount;
                StateHasChanged();
                
                // ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì •í™•í•œ ì”ì•¡ê³¼ ë² íŒ… ë‚´ì—­ ì—…ë°ì´íŠ¸
                _ = Task.Run(async () =>
                {
                    try
                    {
                        await AuthService.RefreshUserAsync();
                        if (AuthService.CurrentUser != null)
                        {
                            await InvokeAsync(() =>
                            {
                                balance = AuthService.CurrentUser.Balance;
                                StateHasChanged();
                            });
                        }
                        
                        var updatedBets = await GameService.GetGraphBetsAsync(userId);
                        await InvokeAsync(() =>
                        {
                            bets = updatedBets;
                            StateHasChanged();
                        });
                    }
                    catch { }
                });
            }
        }
        catch
        {
            // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ UI ì—…ë°ì´íŠ¸
            StateHasChanged();
        }
    }

    private void ResetGame()
    {
        gameFailed = false;
        currentMultiplier = MinMultiplier;
        betAmount = 0;
        graphPoints.Clear();
        StateHasChanged();
    }

    private string GetGraphPath()
    {
        if (graphPoints.Count < 2) return "";

        var path = new System.Text.StringBuilder();
        path.Append($"M {graphPoints[0].x} {graphPoints[0].y}");

        for (int i = 1; i < graphPoints.Count; i++)
        {
            var prev = graphPoints[i - 1];
            var curr = graphPoints[i];
            var cp1x = prev.x + (curr.x - prev.x) / 3;
            var cp1y = prev.y;
            var cp2x = curr.x - (curr.x - prev.x) / 3;
            var cp2y = curr.y;
            path.Append($" C {cp1x} {cp1y}, {cp2x} {cp2y}, {curr.x} {curr.y}");
        }

        return path.ToString();
    }

    private double GetCurrentX()
    {
        if (graphPoints.Count == 0) return 0;
        return graphPoints[graphPoints.Count - 1].x;
    }

    private double GetCurrentY()
    {
        if (graphPoints.Count == 0) return 300;
        return graphPoints[graphPoints.Count - 1].y;
    }

    private void NavigateToLogin()
    {
        Navigation.NavigateTo("/login");
    }

    public async ValueTask DisposeAsync()
    {
        if (timer != null)
        {
            await timer.DisposeAsync();
        }
        if (failureCheckTimer != null)
        {
            await failureCheckTimer.DisposeAsync();
        }
    }
}

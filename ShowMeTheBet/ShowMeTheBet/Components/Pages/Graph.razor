@page "/graph"
@inject ShowMeTheBet.ViewModels.Game.GraphViewModel ViewModel
@inject NavigationManager Navigation
@rendermode InteractiveServer
@implements IDisposable

<PageTitle>ê·¸ë˜í”„ ê²Œì„ - ShowMeTheBet</PageTitle>

@if (ViewModel.IsLoading)
{
    <div style="text-align: center; padding: 50px;">
        <p>ë¡œë”© ì¤‘...</p>
    </div>
}
else if (!ViewModel.IsAuthenticated)
{
    <div class="auth-required">
        <div class="auth-message">
            <h2>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h2>
            <p>ê²Œì„ì„ í•˜ë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>
            <button class="btn btn-primary" @onclick="NavigateToLogin">ë¡œê·¸ì¸í•˜ê¸°</button>
        </div>
    </div>
}
else
{
    <div class="game-container">
        <div class="game-header">
            <h1>ğŸ“ˆ ê·¸ë˜í”„ ê²Œì„</h1>
            <div class="balance-display">
                <span class="balance-label">ì”ì•¡:</span>
                <span class="balance-amount">@ViewModel.Balance.ToString("N0") ì›</span>
            </div>
        </div>

        <div class="game-content">
            <div class="game-main">
                <div class="graph-section">
                    <h3>í˜„ì¬ ë°°ìˆ˜</h3>
                    <div class="graph-container">
                        <svg class="graph-svg" viewBox="0 0 400 300" preserveAspectRatio="none">
                            <defs>
                                <linearGradient id="graphGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                    <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
                                </linearGradient>
                            </defs>
                            <path class="graph-line" d="@ViewModel.GetGraphPath()" fill="none" stroke="url(#graphGradient)" stroke-width="4" />
                            <circle class="graph-dot" cx="@ViewModel.GetCurrentX()" cy="@ViewModel.GetCurrentY()" r="8" fill="#667eea" />
                        </svg>
                        <div class="graph-bar-overlay" style="height: @(ViewModel.CurrentMultiplier * 20)%">
                            <div class="graph-value">x@(ViewModel.CurrentMultiplier.ToString("F2"))</div>
                        </div>
                    </div>
                    <div class="multiplier-display">
                        <span class="multiplier-label">ë°°ìˆ˜:</span>
                        <span class="multiplier-value">x@(ViewModel.CurrentMultiplier.ToString("F2"))</span>
                    </div>
                    @if (ViewModel.IsGameRunning)
                    {
                        <div class="game-status">
                            <p class="status-text">ê²Œì„ ì§„í–‰ ì¤‘...</p>
                        </div>
                    }
                    @if (ViewModel.GameFailed)
                    {
                        <div class="game-status failed">
                            <p class="status-text">âŒ ê²Œì„ ì‹¤íŒ¨!</p>
                        </div>
                    }
                </div>

                <div class="bet-section">
                    <h3>ë² íŒ…í•˜ê¸°</h3>
                    <div class="bet-amount-input">
                        <label>ë² íŒ… ê¸ˆì•¡:</label>
                        <input type="number" 
                               class="form-control" 
                               value="@ViewModel.BetAmount"
                               @oninput="OnBetAmountInput"
                               min="1000" 
                               step="1000"
                               placeholder="ê¸ˆì•¡ ì…ë ¥"
                               disabled="@(ViewModel.IsGameRunning || ViewModel.GameFailed)" />
                        <div class="quick-amount-buttons">
                            <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="() => OnQuickBet(0.25m)" disabled="@(ViewModel.Balance <= 0 || ViewModel.IsGameRunning || ViewModel.GameFailed || ViewModel.IsLoading)">
                                25%
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="() => OnQuickBet(0.50m)" disabled="@(ViewModel.Balance <= 0 || ViewModel.IsGameRunning || ViewModel.GameFailed || ViewModel.IsLoading)">
                                50%
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="() => OnQuickBet(0.75m)" disabled="@(ViewModel.Balance <= 0 || ViewModel.IsGameRunning || ViewModel.GameFailed || ViewModel.IsLoading)">
                                75%
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="() => OnQuickBet(1.00m)" disabled="@(ViewModel.Balance <= 0 || ViewModel.IsGameRunning || ViewModel.GameFailed || ViewModel.IsLoading)">
                                100%
                            </button>
                        </div>
                    </div>
                    <div class="game-controls">
                        @if (!ViewModel.IsGameRunning && !ViewModel.GameFailed)
                        {
                            <button class="btn btn-success btn-start" @onclick="StartGame" disabled="@(ViewModel.BetAmount < 1000 || ViewModel.IsLoading || (ViewModel.Balance > 0 && ViewModel.Balance < ViewModel.BetAmount))">
                                ê²Œì„ ì‹œì‘
                            </button>
                        }
                        else if (ViewModel.IsGameRunning && !ViewModel.GameFailed)
                        {
                            <button class="btn btn-danger btn-stop" @onclick="StopGame" disabled="@ViewModel.IsLoading">
                                STOP!
                            </button>
                        }
                        else if (ViewModel.GameFailed)
                        {
                            <button class="btn btn-primary" @onclick="ResetGame">
                                ë‹¤ì‹œ ì‹œì‘
                            </button>
                        }
                    </div>
                    @if (ViewModel.BetAmount > 0 && (ViewModel.CurrentMultiplier > 1.0m || ViewModel.IsGameRunning))
                    {
                        <div class="bet-summary">
                            <p>ë² íŒ… ê¸ˆì•¡: <strong>@ViewModel.BetAmount.ToString("N0") ì›</strong></p>
                            <p>í˜„ì¬ ë°°ìˆ˜: <strong>x@(ViewModel.CurrentMultiplier.ToString("F2"))</strong></p>
                            <p>ì˜ˆìƒ ë‹¹ì²¨ê¸ˆ: <strong>@ViewModel.PotentialWin.ToString("N0") ì›</strong></p>
                        </div>
                    }
                </div>
            </div>

            <div class="game-history">
                <h3>ë² íŒ… ë‚´ì—­</h3>
                @if (ViewModel.Bets == null || ViewModel.Bets.Count == 0)
                {
                    <div class="empty-history">
                        <p>ë² íŒ… ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                }
                else
                {
                    <div class="bets-list">
                        @foreach (var bet in ViewModel.Bets)
                        {
                            <div class="bet-item @(bet.Status == GameBetStatus.Won ? "won" : "lost")">
                                <div class="bet-info">
                                    <span class="bet-multiplier">x@(bet.Multiplier.ToString("F2"))</span>
                                    <span class="bet-amount">@bet.Amount.ToString("N0") ì›</span>
                                </div>
                                <div class="bet-result">
                                    @if (bet.Status == GameBetStatus.Won)
                                    {
                                        <span class="win-amount">+@((bet.WinAmount - bet.Amount).ToString("N0")) ì›</span>
                                    }
                                    else
                                    {
                                        <span class="lose-amount">-@bet.Amount.ToString("N0") ì›</span>
                                    }
                                </div>
                                <div class="bet-time">@bet.BetTime.ToString("HH:mm:ss")</div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
}

@code {
    private void NavigateToLogin() => Navigation.NavigateTo("/login");

    protected override async Task OnInitializedAsync()
    {
        ViewModel.StateChanged += OnViewModelStateChanged;
        await ViewModel.InitializeAsync();
    }

    private Task OnQuickBet(decimal percentage) => ViewModel.SetBetAmountPercentageAsync(percentage);

    private Task OnBetAmountInput(ChangeEventArgs e) => ViewModel.UpdateBetAmountFromInputAsync(e.Value?.ToString());

    private Task StartGame() => ViewModel.StartGameAsync();
    private Task StopGame() => ViewModel.StopGameAsync();
    private void ResetGame() => ViewModel.ResetGame();

    private void OnViewModelStateChanged() => InvokeAsync(StateHasChanged);

    public void Dispose()
    {
        ViewModel.StateChanged -= OnViewModelStateChanged;
        ViewModel.Dispose();
    }
}


@page "/sports"
@using ShowMeTheBet.Models
@using ShowMeTheBet.Services
@using Microsoft.JSInterop
@inject BettingService BettingService
@inject AuthService AuthService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>스포츠 토토 - ShowMeTheBet</PageTitle>

@if (isLoading)
{
    <div style="text-align: center; padding: 50px;">
        <p>로딩 중...</p>
    </div>
}
else if (!isAuthenticated)
{
    <div class="auth-required">
        <div class="auth-message">
            <h2>로그인이 필요합니다</h2>
            <p>베팅을 하려면 먼저 로그인해주세요.</p>
            <button class="btn btn-primary" @onclick="NavigateToLogin">로그인하기</button>
        </div>
    </div>
}
else
{
    <div class="betting-container">
        <div class="betting-header">
            <h1>⚽ 스포츠 토토</h1>
            <div class="balance-display">
                <span class="balance-label">잔액:</span>
                <span class="balance-amount">@balance.ToString("N0") 원</span>
            </div>
        </div>

        <div class="betting-content">
            <div class="matches-section">
                <h2>경기 목록</h2>
                <div class="matches-list">
                    @if (matches != null)
                    {
                        @foreach (var match in matches)
                        {
                            <div class="match-card">
                                <div class="match-header">
                                    <span class="league-badge">@match.League</span>
                                    <span class="match-time">@match.MatchTime.ToString("MM/dd HH:mm")</span>
                                </div>
                                <div class="match-teams">
                                    <div class="team-section">
                                        <div class="team-name">@match.HomeTeam</div>
                                        <button class="odds-btn @(selectedBets.Any(b => b.MatchId == match.Id && b.Type == BetType.Home) ? "selected" : "")"
                                                @onclick="() => SelectBet(match.Id, BetType.Home, match.HomeOdds, match.HomeTeam, match.AwayTeam)">
                                            <span class="odds-value">@match.HomeOdds.ToString("F2")</span>
                                        </button>
                                    </div>
                                    <div class="team-section">
                                        <div class="team-name draw">무승부</div>
                                        <button class="odds-btn @(selectedBets.Any(b => b.MatchId == match.Id && b.Type == BetType.Draw) ? "selected" : "")"
                                                @onclick="() => SelectBet(match.Id, BetType.Draw, match.DrawOdds, match.HomeTeam, match.AwayTeam)">
                                            <span class="odds-value">@match.DrawOdds.ToString("F2")</span>
                                        </button>
                                    </div>
                                    <div class="team-section">
                                        <div class="team-name">@match.AwayTeam</div>
                                        <button class="odds-btn @(selectedBets.Any(b => b.MatchId == match.Id && b.Type == BetType.Away) ? "selected" : "")"
                                                @onclick="() => SelectBet(match.Id, BetType.Away, match.AwayOdds, match.HomeTeam, match.AwayTeam)">
                                            <span class="odds-value">@match.AwayOdds.ToString("F2")</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>

            <div class="betslip-section">
                <BetSlip Bets="@selectedBets" OnRemove="@RemoveBet" OnPlaceBets="@PlaceBets" />
            </div>
        </div>
    </div>
}

@code {
    private List<BetSlip.BetSlipItem> selectedBets = new();
    private List<Match>? matches;
    private decimal balance = 0;
    private bool isAuthenticated = false;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        StateHasChanged();
        
        // 실서버(IIS)에서 SignalR 연결의 HttpContext 접근 문제를 해결하기 위해
        // JavaScript Interop을 통해 API를 호출하여 인증 상태 확인
        try
        {
            var authResult = await JSRuntime.InvokeAsync<AuthCheckResult>("checkAuth");
            if (authResult != null && authResult.authenticated && authResult.userId.HasValue)
            {
                // API 응답을 기반으로 사용자 정보 로드
                await AuthService.LoadUserByIdAsync(authResult.userId.Value);
                isAuthenticated = true;
                // API 응답의 balance를 사용하거나, RefreshUserAsync 후 GetBalanceAsync 호출
                if (authResult.balance.HasValue)
                {
                    balance = authResult.balance.Value;
                }
                else
                {
                    await AuthService.RefreshUserAsync();
                    balance = await BettingService.GetBalanceAsync();
                }
                matches = await BettingService.GetMatchesAsync();
            }
            else
            {
                // API 호출 실패 시 직접 확인 (로컬 환경 대비)
                AuthService.ResetUserLoad();
                await AuthService.LoadUserFromSessionAsync();
                var user = AuthService.CurrentUser;
                isAuthenticated = user != null;
                
                if (isAuthenticated)
                {
                    await AuthService.RefreshUserAsync();
                    balance = await BettingService.GetBalanceAsync();
                    matches = await BettingService.GetMatchesAsync();
                }
            }
        }
        catch
        {
            // API 호출 실패 시 직접 확인
            AuthService.ResetUserLoad();
            await AuthService.LoadUserFromSessionAsync();
            var user = AuthService.CurrentUser;
            isAuthenticated = user != null;
            
            if (isAuthenticated)
            {
                await AuthService.RefreshUserAsync();
                balance = await BettingService.GetBalanceAsync();
                matches = await BettingService.GetMatchesAsync();
            }
        }
        
        isLoading = false;
        StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !isAuthenticated)
        {
            // 첫 렌더링 후에도 인증 상태를 다시 확인 (SignalR 연결 후 HttpContext가 설정될 수 있음)
            await CheckAuthAndLoadData();
        }
    }

    private async Task CheckAuthAndLoadData()
    {
        try
        {
            var authResult = await JSRuntime.InvokeAsync<AuthCheckResult>("checkAuth");
            if (authResult != null && authResult.authenticated && authResult.userId.HasValue)
            {
                var wasAuthenticated = isAuthenticated;
                await AuthService.LoadUserByIdAsync(authResult.userId.Value);
                isAuthenticated = true;
                
                if (!wasAuthenticated)
                {
                    await AuthService.RefreshUserAsync();
                    balance = await BettingService.GetBalanceAsync();
                    matches = await BettingService.GetMatchesAsync();
                    StateHasChanged();
                }
            }
        }
        catch { }
    }

    private class AuthCheckResult
    {
        public bool success { get; set; }
        public bool authenticated { get; set; }
        public int? userId { get; set; }
        public string? username { get; set; }
        public decimal? balance { get; set; }
    }

    private void SelectBet(int matchId, BetType type, decimal odds, string homeTeam, string awayTeam)
    {
        var existing = selectedBets.FirstOrDefault(b => b.MatchId == matchId);
        if (existing != null)
        {
            selectedBets.Remove(existing);
        }
        
        selectedBets.Add(new BetSlip.BetSlipItem
        {
            MatchId = matchId,
            MatchInfo = $"{homeTeam} vs {awayTeam}",
            Type = type,
            Odds = odds,
            Amount = 0
        });
        StateHasChanged();
    }

    private void RemoveBet(int matchId)
    {
        selectedBets.RemoveAll(b => b.MatchId == matchId);
        StateHasChanged();
    }

    private async Task PlaceBets()
    {
        // 베팅 전에 사용자 정보 다시 로드
        if (AuthService.CurrentUser == null)
        {
            await AuthService.LoadUserFromSessionAsync();
        }
        
        foreach (var bet in selectedBets.Where(b => b.Amount > 0))
        {
            await BettingService.PlaceBetAsync(bet.MatchId, bet.Type, bet.Amount);
        }
        selectedBets.Clear();
        balance = await BettingService.GetBalanceAsync();
        StateHasChanged();
    }

    private void NavigateToLogin()
    {
        Navigation.NavigateTo("/login");
    }
}


@page "/game"
@using ShowMeTheBet.Models
@using ShowMeTheBet.Services
@using Microsoft.AspNetCore.Http
@using Microsoft.JSInterop
@inject BettingService BettingService
@inject AuthService AuthService
@inject NavigationManager Navigation
@inject IHttpContextAccessor HttpContextAccessor
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>ShowMeTheBet</PageTitle>

@if (isLoading)
{
    <div style="text-align: center; padding: 50px;">
        <p>ë¡œë”© ì¤‘...</p>
    </div>
}
else if (!isAuthenticated)
{
    <div class="auth-required">
        <div class="auth-message">
            <h2>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h2>
            <p>ë² íŒ…ì„ í•˜ë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>
            <button class="btn btn-primary" @onclick="NavigateToLogin">ë¡œê·¸ì¸í•˜ê¸°</button>
        </div>
    </div>
}
else
{
    <div class="main-container">
        <div class="main-header">
            <h1>âš½ ShowMeTheBet</h1>
            <div class="balance-display">
                <span class="balance-label">ì”ì•¡:</span>
                <span class="balance-amount">@balance.ToString("N0") ì›</span>
            </div>
        </div>

        <div class="games-menu">
            <h2>ê²Œì„ ì„ íƒ</h2>
            <div class="games-grid">
                <div class="game-card" @onclick="NavigateToSports">
                    <div class="game-icon">âš½</div>
                    <h3>ìŠ¤í¬ì¸  í† í† </h3>
                    <p>ì‹¤ì‹œê°„ ê²½ê¸° ë² íŒ…</p>
                    <div class="game-badge">ìŠ¤í¬ì¸ </div>
                </div>

                <div class="game-card" @onclick="NavigateToOddEven">
                    <div class="game-icon">ğŸ²</div>
                    <h3>í™€ì§</h3>
                    <p>30ì´ˆë§ˆë‹¤ ê²°ê³¼ ë°œí‘œ</p>
                    <div class="game-badge">x2.0</div>
                </div>

                <div class="game-card" @onclick="NavigateToGraph">
                    <div class="game-icon">ğŸ“ˆ</div>
                    <h3>ê·¸ë˜í”„</h3>
                    <p>ë°°ìˆ˜ ê²Œì„ (x1 ~ x5)</p>
                    <div class="game-badge">ë°°ìˆ˜</div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private decimal balance = 0;
    private bool isAuthenticated = false;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        StateHasChanged();
        
        // ì‹¤ì„œë²„(IIS)ì—ì„œ SignalR ì—°ê²°ì˜ HttpContext ì ‘ê·¼ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´
        // JavaScript Interopì„ í†µí•´ APIë¥¼ í˜¸ì¶œí•˜ì—¬ ì¸ì¦ ìƒíƒœ í™•ì¸
        try
        {
            var authResult = await JSRuntime.InvokeAsync<AuthCheckResult>("checkAuth");
            if (authResult != null && authResult.authenticated && authResult.userId.HasValue)
            {
                // API ì‘ë‹µì„ ê¸°ë°˜ìœ¼ë¡œ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
                await AuthService.LoadUserByIdAsync(authResult.userId.Value);
                isAuthenticated = true;
                // API ì‘ë‹µì˜ balanceë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜, RefreshUserAsync í›„ GetBalanceAsync í˜¸ì¶œ
                if (authResult.balance.HasValue)
                {
                    balance = authResult.balance.Value;
                }
                else
                {
                    await AuthService.RefreshUserAsync();
                    balance = await BettingService.GetBalanceAsync();
                }
            }
            else
            {
                // API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ì§ì ‘ í™•ì¸ (ë¡œì»¬ í™˜ê²½ ëŒ€ë¹„)
                AuthService.ResetUserLoad();
                await AuthService.LoadUserFromSessionAsync();
                var user = AuthService.CurrentUser;
                isAuthenticated = user != null;
                
                if (isAuthenticated)
                {
                    await AuthService.RefreshUserAsync();
                    balance = await BettingService.GetBalanceAsync();
                }
            }
        }
        catch
        {
            // API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ì§ì ‘ í™•ì¸
            AuthService.ResetUserLoad();
            await AuthService.LoadUserFromSessionAsync();
            var user = AuthService.CurrentUser;
            isAuthenticated = user != null;
            
            if (isAuthenticated)
            {
                await AuthService.RefreshUserAsync();
                balance = await BettingService.GetBalanceAsync();
            }
        }
        
        isLoading = false;
        StateHasChanged();
    }

    protected override async Task OnParametersSetAsync()
    {
        // íŒŒë¼ë¯¸í„° ë³€ê²½ ì‹œ ì”ì•¡ì´ 0ì´ë©´ ì¬ë¡œë“œ
        if (isAuthenticated && balance == 0)
        {
            await AuthService.RefreshUserAsync();
            balance = await BettingService.GetBalanceAsync();
            StateHasChanged();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !isAuthenticated)
        {
            // ì²« ë Œë”ë§ í›„ì—ë„ ì¸ì¦ ìƒíƒœë¥¼ ë‹¤ì‹œ í™•ì¸ (SignalR ì—°ê²° í›„ HttpContextê°€ ì„¤ì •ë  ìˆ˜ ìˆìŒ)
            await CheckAuthAndLoadData();
        }
        else if (firstRender && isAuthenticated && balance == 0)
        {
            // ì¸ì¦ë˜ì—ˆì§€ë§Œ ì”ì•¡ì´ 0ì´ë©´ ì¬ë¡œë“œ
            await AuthService.RefreshUserAsync();
            balance = await BettingService.GetBalanceAsync();
            StateHasChanged();
        }
    }

    private async Task CheckAuthAndLoadData()
    {
        try
        {
            var authResult = await JSRuntime.InvokeAsync<AuthCheckResult>("checkAuth");
            if (authResult != null && authResult.authenticated && authResult.userId.HasValue)
            {
                var wasAuthenticated = isAuthenticated;
                await AuthService.LoadUserByIdAsync(authResult.userId.Value);
                isAuthenticated = true;
                
                if (!wasAuthenticated || balance == 0)
                {
                    await AuthService.RefreshUserAsync();
                    balance = await BettingService.GetBalanceAsync();
                }
                
                if (wasAuthenticated != isAuthenticated)
                {
                    StateHasChanged();
                }
            }
            else
            {
                // API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ì§ì ‘ í™•ì¸
                AuthService.ResetUserLoad();
                await AuthService.LoadUserFromSessionAsync();
                var user = AuthService.CurrentUser;
                var wasAuthenticated = isAuthenticated;
                isAuthenticated = user != null;
                
                if (isAuthenticated && (!wasAuthenticated || balance == 0))
                {
                    balance = await BettingService.GetBalanceAsync();
                }
                
                if (wasAuthenticated != isAuthenticated)
                {
                    StateHasChanged();
                }
            }
        }
        catch
        {
            // API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ì§ì ‘ í™•ì¸
            AuthService.ResetUserLoad();
            await AuthService.LoadUserFromSessionAsync();
            var user = AuthService.CurrentUser;
            var wasAuthenticated = isAuthenticated;
            isAuthenticated = user != null;
            
            if (isAuthenticated && (!wasAuthenticated || balance == 0))
            {
                balance = await BettingService.GetBalanceAsync();
            }
            
            if (wasAuthenticated != isAuthenticated)
            {
                StateHasChanged();
            }
        }
    }

    private class AuthCheckResult
    {
        public bool success { get; set; }
        public bool authenticated { get; set; }
        public int? userId { get; set; }
        public string? username { get; set; }
        public decimal? balance { get; set; }
    }

    private void NavigateToLogin()
    {
        Navigation.NavigateTo("/login");
    }

    private void NavigateToSports()
    {
        Navigation.NavigateTo("/sports");
    }

    private void NavigateToOddEven()
    {
        Navigation.NavigateTo("/oddeven");
    }

    private void NavigateToGraph()
    {
        Navigation.NavigateTo("/graph");
    }
}

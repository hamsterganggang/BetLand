@page "/register"
@inject ShowMeTheBet.Services.AuthPageService AuthPageService
@rendermode InteractiveServer

<PageTitle>회원가입 - 도토리</PageTitle>

<div class="register-page">
    <div class="register-card">
        <div class="register-side">
            <h1>새로운 베팅 여정을 시작하세요</h1>
            <p>맞춤형 게임 경험을 즐기고 실시간 배당을 확인해보세요.</p>
            <ul>
                <li>실시간 그래프 &amp; 홀짝 게임</li>
                <li>스포츠 경기 라이브 베팅</li>
                <li>보안 강화된 자산 관리</li>
                <li>* 본 페이지는 건강한 베팅 놀이터 입니다.</li>
            </ul>
        </div>

        <div class="register-form">
            <div class="register-header">
                <h2>회원가입</h2>
                <p class="text-muted">아래 정보를 입력해 새 계정을 만들어보세요.</p>
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger" role="alert">
                    @errorMessage
                </div>
            }

            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="alert alert-success" role="alert">
                    @successMessage
                </div>
            }

            <div class="form-group">
                <label for="username" class="form-label">사용자명</label>
                <input type="text"
                       class="form-control"
                       id="username"
                       @bind="username"
                       @bind:event="oninput"
                       placeholder="사용자명을 입력하세요"
                       required />
                <small class="form-text text-muted">3-20자, 영문, 숫자, 언더스코어만 사용 가능</small>
            </div>

            <div class="form-group">
                <label for="email" class="form-label">이메일</label>
                <input type="email"
                       class="form-control"
                       id="email"
                       @bind="email"
                       @bind:event="oninput"
                       placeholder="이메일을 입력하세요"
                       required />
            </div>

            <div class="form-group">
                <label for="password" class="form-label">비밀번호</label>
                <input type="password"
                       class="form-control"
                       id="password"
                       @bind="password"
                       @bind:event="oninput"
                       placeholder="비밀번호를 입력하세요"
                       required />
                <small class="form-text text-muted">최소 6자 이상</small>
            </div>

            <div class="form-group">
                <label for="passwordConfirm" class="form-label">비밀번호 확인</label>
                <input type="password"
                       class="form-control"
                       id="passwordConfirm"
                       @bind="passwordConfirm"
                       @bind:event="oninput"
                       placeholder="비밀번호를 다시 입력하세요"
                       required />
                @if (!string.IsNullOrEmpty(password) && !string.IsNullOrEmpty(passwordConfirm) && password != passwordConfirm)
                {
                    <small class="form-text text-danger">비밀번호가 일치하지 않습니다</small>
                }
            </div>

            <button class="btn btn-primary w-100 mb-3" @onclick="HandleRegister" disabled="@(isLoading || !IsFormValid())">
                @if (isLoading)
                {
                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                }
                회원가입
            </button>

            <div class="text-center">
                <p class="mb-0">이미 계정이 있으신가요? <a href="/login">로그인</a></p>
            </div>
        </div>
    </div>
</div>

@code {
    private string username = string.Empty;
    private string email = string.Empty;
    private string password = string.Empty;
    private string passwordConfirm = string.Empty;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    private bool isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        await AuthPageService.RedirectIfAuthenticatedAsync("/game", reloadSession: true);
    }

    private bool IsFormValid()
    {
        return !string.IsNullOrWhiteSpace(username) &&
               !string.IsNullOrWhiteSpace(email) &&
               !string.IsNullOrWhiteSpace(password) &&
               !string.IsNullOrWhiteSpace(passwordConfirm) &&
               password == passwordConfirm &&
               password.Length >= 6 &&
               username.Length >= 3 &&
               username.Length <= 20;
    }

    private async Task HandleRegister()
    {
        errorMessage = string.Empty;
        successMessage = string.Empty;

        isLoading = true;
        var result = await AuthPageService.RegisterAsync(username, email, password, passwordConfirm);
        isLoading = false;

        if (result.Success)
        {
            successMessage = result.SuccessMessage ?? "회원가입이 완료되었습니다!";
        }
        else
        {
            errorMessage = result.ErrorMessage ?? "회원가입 중 오류가 발생했습니다.";
        }
    }
}


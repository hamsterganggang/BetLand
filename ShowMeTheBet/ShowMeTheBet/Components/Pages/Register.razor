@page "/register"
@using ShowMeTheBet.Services
@inject AuthService AuthService
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>회원가입 - ShowMeTheBet</PageTitle>

<div class="login-container">
    <div class="login-card">
        <div class="login-header">
            <h1>⚽ ShowMeTheBet</h1>
            <p class="text-muted">새 계정을 만들어보세요</p>
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger" role="alert">
                @errorMessage
            </div>
        }

        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert alert-success" role="alert">
                @successMessage
            </div>
        }

        <div class="login-form">
            <h3>회원가입</h3>
            <div class="mb-3">
                <label for="username" class="form-label">사용자명</label>
                <input type="text" 
                       class="form-control" 
                       id="username" 
                       @bind="username" 
                       @bind:event="oninput"
                       placeholder="사용자명을 입력하세요" 
                       required />
                <small class="form-text text-muted">3-20자, 영문, 숫자, 언더스코어만 사용 가능</small>
            </div>
            <div class="mb-3">
                <label for="email" class="form-label">이메일</label>
                <input type="email" 
                       class="form-control" 
                       id="email" 
                       @bind="email" 
                       @bind:event="oninput"
                       placeholder="이메일을 입력하세요" 
                       required />
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">비밀번호</label>
                <input type="password" 
                       class="form-control" 
                       id="password" 
                       @bind="password" 
                       @bind:event="oninput"
                       placeholder="비밀번호를 입력하세요" 
                       required />
                <small class="form-text text-muted">최소 6자 이상</small>
            </div>
            <div class="mb-3">
                <label for="passwordConfirm" class="form-label">비밀번호 확인</label>
                <input type="password" 
                       class="form-control" 
                       id="passwordConfirm" 
                       @bind="passwordConfirm" 
                       @bind:event="oninput"
                       placeholder="비밀번호를 다시 입력하세요" 
                       required />
                @if (!string.IsNullOrEmpty(password) && !string.IsNullOrEmpty(passwordConfirm) && password != passwordConfirm)
                {
                    <small class="form-text text-danger">비밀번호가 일치하지 않습니다</small>
                }
            </div>
            <button class="btn btn-primary w-100 mb-3" @onclick="HandleRegister" disabled="@(isLoading || !IsFormValid())">
                @if (isLoading)
                {
                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                }
                회원가입
            </button>
            <div class="text-center">
                <p class="mb-0">이미 계정이 있으신가요? <a href="/login">로그인</a></p>
            </div>
        </div>
    </div>
</div>

@code {
    private string username = string.Empty;
    private string email = string.Empty;
    private string password = string.Empty;
    private string passwordConfirm = string.Empty;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    private bool isLoading = false;

    protected override void OnInitialized()
    {
        if (AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/");
        }
    }

    private bool IsFormValid()
    {
        return !string.IsNullOrWhiteSpace(username) &&
               !string.IsNullOrWhiteSpace(email) &&
               !string.IsNullOrWhiteSpace(password) &&
               !string.IsNullOrWhiteSpace(passwordConfirm) &&
               password == passwordConfirm &&
               password.Length >= 6 &&
               username.Length >= 3 &&
               username.Length <= 20;
    }

    private async Task HandleRegister()
    {
        errorMessage = string.Empty;
        successMessage = string.Empty;

        // 유효성 검사
        if (string.IsNullOrWhiteSpace(username))
        {
            errorMessage = "사용자명을 입력해주세요.";
            return;
        }

        if (username.Length < 3 || username.Length > 20)
        {
            errorMessage = "사용자명은 3-20자 사이여야 합니다.";
            return;
        }

        if (string.IsNullOrWhiteSpace(email))
        {
            errorMessage = "이메일을 입력해주세요.";
            return;
        }

        if (!email.Contains("@") || !email.Contains("."))
        {
            errorMessage = "올바른 이메일 형식을 입력해주세요.";
            return;
        }

        if (string.IsNullOrWhiteSpace(password))
        {
            errorMessage = "비밀번호를 입력해주세요.";
            return;
        }

        if (password.Length < 6)
        {
            errorMessage = "비밀번호는 최소 6자 이상이어야 합니다.";
            return;
        }

        if (password != passwordConfirm)
        {
            errorMessage = "비밀번호가 일치하지 않습니다.";
            return;
        }

        isLoading = true;
        try
        {
            var success = await AuthService.RegisterAsync(username, email, password);
            if (success)
            {
                successMessage = "회원가입이 완료되었습니다! 로그인 페이지로 이동합니다...";
                
                // 2초 후 자동 로그인 시도
                await Task.Delay(2000);
                
                var loginSuccess = await AuthService.LoginAsync(username, password);
                if (loginSuccess)
                {
                    Navigation.NavigateTo("/");
                }
                else
                {
                    Navigation.NavigateTo("/login");
                }
            }
            else
            {
                errorMessage = "이미 존재하는 사용자명 또는 이메일입니다.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = "회원가입 중 오류가 발생했습니다: " + ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }
}

